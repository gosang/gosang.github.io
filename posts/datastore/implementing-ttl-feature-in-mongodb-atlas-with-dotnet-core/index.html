<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en-us lang=en-us><head><script defer language=javascript type=text/javascript src=/js/bundle.min.11d62625e7495f8147fccf5d08f37bded574a50c4508c235cc666848567d99ab.js></script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon href=/favicon.png><title itemprop=name>Go Sang - Implementing TTL (Time To Live) Feature in Mongodb Atlas With Dotnet Core</title><meta property="og:title" content="Go Sang - Implementing TTL (Time To Live) Feature in Mongodb Atlas With Dotnet Core"><meta name=twitter:title content="Go Sang - Implementing TTL (Time To Live) Feature in Mongodb Atlas With Dotnet Core"><meta itemprop=name content="Go Sang - Implementing TTL (Time To Live) Feature in Mongodb Atlas With Dotnet Core"><meta name=application-name content="Go Sang - Implementing TTL (Time To Live) Feature in Mongodb Atlas With Dotnet Core"><meta property="og:site_name" content><meta name=description content><meta itemprop=description content><meta property="og:description" content><meta name=twitter:description content><base href=https://gosang.github.io/posts/datastore/implementing-ttl-feature-in-mongodb-atlas-with-dotnet-core/><link rel=canonical href=https://gosang.github.io/posts/datastore/implementing-ttl-feature-in-mongodb-atlas-with-dotnet-core/ itemprop=url><meta name=url content="https://gosang.github.io/posts/datastore/implementing-ttl-feature-in-mongodb-atlas-with-dotnet-core/"><meta name=twitter:url content="https://gosang.github.io/posts/datastore/implementing-ttl-feature-in-mongodb-atlas-with-dotnet-core/"><meta property="og:url" content="https://gosang.github.io/posts/datastore/implementing-ttl-feature-in-mongodb-atlas-with-dotnet-core/"><meta property="og:updated_time" content="13001-13-12T142:54:24Z"><link rel=sitemap type=application/xml title=Sitemap href=https://gosang.github.io/sitemap.xml><meta name=robots content="index,follow"><meta name=googlebot content="index,follow"><meta name=twitter:site content><meta name=twitter:creator content><meta property="fb:admins" content><meta name=apple-mobile-web-app-title content><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="black"><meta property="og:type" content="article"><meta property="article:publisher" content><meta property="og:article:published_time" content="13001-13-12T142:54:24Z"><meta property="article:published_time" content="13001-13-12T142:54:24Z"><script defer type=application/ld+json>{"@context":"http://schema.org","@type":"Article","headline":"Implementing TTL (Time To Live) Feature in Mongodb Atlas With Dotnet Core","author":{"@type":"Person","name":"https:\/\/github.com\/gosang"},"datePublished":"2024-01-13","description":"","wordCount":"1511","mainEntityOfPage":"True","dateModified":"2024-01-13","image":{"@type":"imageObject","url":""},"publisher":{"@type":"Organization","name":"","logo":{"@type":"imageObject","url":""}}}</script><meta name=generator content="Hugo 0.119.0"><link type=text/css rel=stylesheet href=/css/bundle.min.178e339ccb9acabffeebf9adbb0bb23c1ec0b72a2a50edee18a5007d4d5a68aa.css><style>body{--sidebar-bg-color:#202020;--sidebar-img-border-color:#515151;--sidebar-p-color:#909090;--sidebar-h1-color:#FFF;--sidebar-a-color:#FFF;--sidebar-socials-color:#FFF;--text-color:#222;--bkg-color:#FAF9F6;--post-title-color:#303030;--list-color:#5a5a5a;--link-color:#268bd2;--date-color:#515151;--table-border-color:#E5E5E5;--table-stripe-color:#F9F9F9;--code-color:#bf616a;--code-background-color:#E5E5E5;--moon-sun-color:#FFF;--moon-sun-background-color:#515151}body.dark-theme{--text-color:#eee;--bkg-color:#121212;--post-title-color:#DBE2E9;--list-color:#9d9d9d;--link-color:#268bd2;--date-color:#9a9a9a;--table-border-color:#515151;--table-stripe-color:#202020;--code-color:#ff7f7f;--code-background-color:#393D47}body{background-color:var(--bkg-color)}</style></head><body><div class=wrapper><aside class=sidebar><div class="container sidebar-sticky"><div class=light-dark align=right><button class=btn-light-dark title="Toggle light/dark mode"><svg class="moon" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 16 16"><path fill="currentcolor" d="M6 .278a.768.768.0 01.08.858 7.208 7.208.0 00-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527.0 1.04-.055 1.533-.16a.787.787.0 01.81.316.733.733.0 01-.031.893A8.349 8.349.0 018.344 16C3.734 16 0 12.286.0 7.71.0 4.266 2.114 1.312 5.124.06A.752.752.0 016 .278z"/></svg><svg class="sun" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 16 16"><path fill="currentcolor" d="M8 12a4 4 0 100-8 4 4 0 000 8zM8 0a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 0zm0 13a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 13zm8-5a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2a.5.5.0 01.5.5zM3 8a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2A.5.5.0 013 8zm10.657-5.657a.5.5.0 010 .707l-1.414 1.415a.5.5.0 11-.707-.708l1.414-1.414a.5.5.0 01.707.0zm-9.193 9.193a.5.5.0 010 .707L3.05 13.657a.5.5.0 01-.707-.707l1.414-1.414a.5.5.0 01.707.0zm9.193 2.121a.5.5.0 01-.707.0l-1.414-1.414a.5.5.0 01.707-.707l1.414 1.414a.5.5.0 010 .707zM4.464 4.465a.5.5.0 01-.707.0L2.343 3.05a.5.5.0 11.707-.707l1.414 1.414a.5.5.0 010 .708z"/></svg></button></div><div class=sidebar-about><h1 class=brand><a href=https://gosang.github.io/><h1>Go Sang</h1></a></h1><p class=lead>Learning about technology.</p></div><nav><ul class=sidebar-nav><li class=heading><a href=/posts/>Posts</a></li><li class=sub-heading>Recent</li><li class=bullet><a href=https://gosang.github.io/posts/dotnet/implementing-postgresql-in-asp-dotnet-core/>Implementing PostgreSQL with ASP.NET Core</a></li><li class=bullet><a href=https://gosang.github.io/posts/dotnet/implementing-uuid-in-asp-dotnet-core/>Implementing UUID in ASP.NET Core 8</a></li><li class=bullet><a href=https://gosang.github.io/posts/dotnet/implementing-guid-in-asp-dotnet-core/>Implementing GUID in ASP.NET Core</a></li><li class=bullet><a href=https://gosang.github.io/posts/dotnet/implementing-minimal-api-with-asp-dotnet-core-using-pepr/>Implementing Minimal API With ASP.NET Core Using Request Endpoint Response</a></li><li class=bullet><a href=https://gosang.github.io/posts/dotnet/implementing-notification-service-with-aws-sns-in-asp-dotnet-core/>Implementing Notification Service with Amazon SNS in ASP.NET Core 8 API</a></li></ul></nav><a target=_blank class=social title=GitHub href=https://github.com/gosang><svg xmlns="http://www.w3.org/2000/svg" width="1.2em" height="1.2em" viewBox="-2 -2 24 24"><path fill="currentcolor" d="M18.88 1.099C18.147.366 17.265.0 16.233.0H3.746C2.714.0 1.832.366 1.099 1.099.366 1.832.0 2.714.0 3.746v12.487c0 1.032.366 1.914 1.099 2.647.733.733 1.615 1.099 2.647 1.099H6.66c.19.0.333-.007.429-.02a.504.504.0 00.286-.169c.095-.1.143-.245.143-.435l-.007-.885c-.004-.564-.006-1.01-.006-1.34l-.3.052c-.19.035-.43.05-.721.046a5.555 5.555.0 01-.904-.091 2.026 2.026.0 01-.872-.39 1.651 1.651.0 01-.572-.8l-.13-.3a3.25 3.25.0 00-.41-.663c-.186-.243-.375-.407-.566-.494l-.09-.065a.956.956.0 01-.17-.156.723.723.0 01-.117-.182c-.026-.061-.004-.111.065-.15.07-.04.195-.059.378-.059l.26.04c.173.034.388.138.643.311a2.1 2.1.0 01.631.677c.2.355.44.626.722.813.282.186.566.28.852.28.286.0.533-.022.742-.065a2.59 2.59.0 00.585-.196c.078-.58.29-1.028.637-1.34a8.907 8.907.0 01-1.333-.234 5.314 5.314.0 01-1.223-.507 3.5 3.5.0 01-1.047-.872c-.277-.347-.505-.802-.683-1.365-.177-.564-.266-1.215-.266-1.952.0-1.049.342-1.942 1.027-2.68-.32-.788-.29-1.673.091-2.652.252-.079.625-.02 1.119.175.494.195.856.362 1.086.5.23.14.414.257.553.352a9.233 9.233.0 012.497-.338c.859.0 1.691.113 2.498.338l.494-.312a6.997 6.997.0 011.197-.572c.46-.174.81-.221 1.054-.143.39.98.424 1.864.103 2.653.685.737 1.028 1.63 1.028 2.68.0.737-.089 1.39-.267 1.957-.177.568-.407 1.023-.689 1.366a3.65 3.65.0 01-1.053.865c-.42.234-.828.403-1.223.507a8.9 8.9.0 01-1.333.235c.45.39.676 1.005.676 1.846v3.11c0 .147.021.266.065.357a.36.36.0 00.208.189c.096.034.18.056.254.064.074.01.18.013.318.013h2.914c1.032.0 1.914-.366 2.647-1.099.732-.732 1.099-1.615 1.099-2.647V3.746c0-1.032-.367-1.914-1.1-2.647z"/></svg></a><a target=_blank class=social title="RSS Feed" href=https://gosang.github.io//posts/index.xml><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1.2em" viewBox="0 0 1280 1280"><g transform="translate(0.000000,1280.000000) scale(0.100000,-0.100000)" fill="currentcolor"><path d="M2295 11929c-284-12-642-45-707-65-17-5-18-63-18-1039 0-569 4-1036 8-1039 5-3 74 6 153 19 510 86 1168 95 1789 25 1348-153 2602-677 3670-1531 385-308 820-744 1126-1129 842-1060 1362-2313 1514-3650 70-621 61-1279-25-1789-13-79-22-148-19-153 3-4 471-8 1039-8h1035l5 23c51 225 85 942 67 1419-23 605-77 1044-198 1617-294 14e2-927 2734-1823 3846-1043 1295-2364 2259-3909 2854-1158 447-2451 656-3707 6e2z"/><path d="M2255 7845c-269-25-620-81-667-106-17-9-18-55-18-899 0-706 3-890 13-890 6 0 66 18 132 41 130 44 288 79 467 105 154 21 577 30 749 15 1207-107 2267-823 2814-1902 166-327 268-637 330-1001 38-227 48-384 42-662-8-348-44-590-126-831-23-66-41-126-41-132 0-10 184-13 890-13 844 0 890 1 899 18 27 50 88 452 110 725 14 162 14 624 1 782-59 703-233 1323-545 1945-481 956-1313 1788-2270 2268-620 310-1239 483-1940 542-165 14-669 10-840-5z"/><path d="M2519 3815c-391-66-725-336-868-703-79-201-96-462-45-677 83-344 338-641 666-774 116-47 205-69 330-80 412-39 811 153 1040 5e2 193 292 240 648 128 981-135 403-492 699-914 757-1e2 14-241 12-337-4z"/></g></svg></a><p class=footnote>powered by <a target=_blank href=https://gohugo.io>Hugo</a> | themed with <a target=_blank href=https://github.com/lukeorth/poison>poison</a><br>&copy; 2025 . All rights reserved.</p></div></aside><main class="content container"><div class=post><div class=info><h1 class=post-title><a href=https://gosang.github.io/posts/datastore/implementing-ttl-feature-in-mongodb-atlas-with-dotnet-core/>Implementing TTL (Time To Live) Feature in Mongodb Atlas With Dotnet Core</a></h1><time datetime=2024-01-13T12:42:54Z class=post-date>January 13, 2024</time><ul class=tags><li class=tag-TTL><a href=https://gosang.github.io/tags/ttl>TTL</a></li><li class="tag-ASP.Net Core"><a href=https://gosang.github.io/tags/asp.net-core>ASP.Net Core</a></li><li class=tag-MongoDB><a href=https://gosang.github.io/tags/mongodb>MongoDB</a></li></ul><p class=seriesname>Series: <a href=https://gosang.github.io/series/data-store>Data Store</a></p></div><h1 id=introduction>Introduction</h1><p>MongoDB, a popular NoSQL database, offers a unique feature called Time to Live (TTL), which allows documents to automatically expire after a specified period. In this blog post, we will explore the concept of TTL, its rationale, and how to implement it in an ASP.NET Core application using the MongoDB driver. We will use an e-commerce system as a case study to demonstrate the practical application of TTL in the context of microservices.</p><h1 id=understanding-time-to-live-ttl>Understanding Time to Live (TTL)</h1><h2 id=what-is-ttl>What is TTL?</h2><p>Time to Live (TTL) is a mechanism that enables documents in a MongoDB collection to have a limited lifespan. When a TTL index is applied to a field in a document, MongoDB automatically removes documents where the TTL field value is older than the specified duration.</p><h2 id=why-ttl-and-problem-resolution>Why TTL and Problem Resolution</h2><p>TTL is particularly useful for scenarios where data has a finite relevance or validity period. In an e-commerce system, for instance, order or shopping cart documents may become irrelevant after a certain time, reducing database clutter and improving performance.</p><h1 id=ways-to-implement-ttl-in-mongodb>Ways to Implement TTL in MongoDB</h1><h2 id=1-expire-documents>1. Expire Documents</h2><p>The simplest way to use TTL is to let MongoDB expire documents after a certain number of seconds. This method is suitable when documents have a fixed lifespan, such as session data or temporary records.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>var</span> keys = Builders&lt;BsonDocument&gt;.IndexKeys.Ascending(<span style=color:#e6db74>&#34;expireAt&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> options = <span style=color:#66d9ef>new</span> CreateIndexOptions { ExpireAfter = <span style=color:#66d9ef>new</span> TimeSpan(<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>3600</span>) };
</span></span><span style=display:flex><span>collection.Indexes.CreateOne(<span style=color:#66d9ef>new</span> BsonDocumentIndex(keys, options));
</span></span></code></pre></div><h2 id=2-expire-documents-with-filter-conditions>2. Expire Documents with Filter Conditions</h2><p>For more granular control, TTL can be applied based on specific filter conditions. This is beneficial when different documents in the same collection have varying lifespans.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>var</span> filter = Builders&lt;BsonDocument&gt;.Filter.Eq(<span style=color:#e6db74>&#34;status&#34;</span>, <span style=color:#e6db74>&#34;expired&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> keys = Builders&lt;BsonDocument&gt;.IndexKeys.Ascending(<span style=color:#e6db74>&#34;expireAt&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> options = <span style=color:#66d9ef>new</span> CreateIndexOptions { ExpireAfter = <span style=color:#66d9ef>new</span> TimeSpan(<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>) };
</span></span><span style=display:flex><span>collection.Indexes.CreateOne(<span style=color:#66d9ef>new</span> BsonDocumentIndex(keys, options));
</span></span></code></pre></div><h2 id=3-expire-documents-at-a-specific-clock-time>3. Expire Documents at a Specific Clock Time</h2><p>In some scenarios, it might be necessary to expire documents at a specific clock time rather than a duration. This can be achieved using the expireAfterSeconds option with a negative value.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>var</span> keys = Builders&lt;BsonDocument&gt;.IndexKeys.Ascending(<span style=color:#e6db74>&#34;expireAt&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> options = <span style=color:#66d9ef>new</span> CreateIndexOptions { ExpireAfter = <span style=color:#66d9ef>new</span> TimeSpan(<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, -<span style=color:#ae81ff>1</span>) };
</span></span><span style=display:flex><span>collection.Indexes.CreateOne(<span style=color:#66d9ef>new</span> BsonDocumentIndex(keys, options));
</span></span></code></pre></div><h1 id=implementation-in-aspnet-core-e-commerce-system>Implementation in ASP.NET Core E-commerce System</h1><p>In our ASP.NET Core e-commerce system, we&rsquo;ll illustrate the implementation of the TTL feature using MongoDB Atlas as the database. Assume an example use case where order documents should expire one hour after their creation.</p><h2 id=example-use-case>Example Use Case</h2><p>In an e-commerce system, consider the need to automatically remove orders that have not been completed within a specific timeframe. The TTL feature will be applied to the order documents, ensuring they expire and are removed from the database after one hour.</p><p>Repository C# Code</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#75715e>// Order Model representing MongoDB document</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Order</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> ObjectId Id { <span style=color:#66d9ef>get</span>; <span style=color:#66d9ef>set</span>; }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>string</span> OrderNumber { <span style=color:#66d9ef>get</span>; <span style=color:#66d9ef>set</span>; }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> DateTime CreatedAt { <span style=color:#66d9ef>get</span>; <span style=color:#66d9ef>set</span>; }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> DateTime ExpireAt { <span style=color:#66d9ef>get</span>; <span style=color:#66d9ef>set</span>; }
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Other order properties...</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// OrderRepository responsible for interacting with MongoDB</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>OrderRepository</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>readonly</span> IMongoCollection&lt;Order&gt; _collection;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>readonly</span> TimeSpan _orderTtl;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> OrderRepository(IMongoClient client, IConfiguration configuration, IOptions&lt;OrderRepositorySettings&gt; settings)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> databaseName = configuration[<span style=color:#e6db74>&#34;MongoDB:DatabaseName&#34;</span>];
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> collectionName = <span style=color:#e6db74>&#34;orders&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> database = client.GetDatabase(databaseName);
</span></span><span style=display:flex><span>        _collection = database.GetCollection&lt;Order&gt;(collectionName);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Retrieve TTL from app settings</span>
</span></span><span style=display:flex><span>        _orderTtl = settings.Value.OrderTtl;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// TTL index creation</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> keys = Builders&lt;Order&gt;.IndexKeys.Ascending(<span style=color:#e6db74>&#34;expireAt&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> options = <span style=color:#66d9ef>new</span> CreateIndexOptions { ExpireAfter = _orderTtl };
</span></span><span style=display:flex><span>        _collection.Indexes.CreateOne(<span style=color:#66d9ef>new</span> BsonDocumentIndex(keys, options));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Method to create a new order</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> CreateOrder(Order order)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Set expiration time</span>
</span></span><span style=display:flex><span>        order.ExpireAt = order.CreatedAt.Add(_orderTtl);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Insert order into MongoDB</span>
</span></span><span style=display:flex><span>        _collection.InsertOne(order);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Other repository methods...</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// OrderRepositorySettings class to read TTL settings from app settings</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>OrderRepositorySettings</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> TimeSpan OrderTtl { <span style=color:#66d9ef>get</span>; <span style=color:#66d9ef>set</span>; }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>In this code snippet, the <code>OrderRepository</code> class includes the creation of the TTL index, setting the expiration time for orders, and inserting orders into the MongoDB collection. The <code>OrderRepositorySettings</code> class is used to read the TTL value from the app settings.</p><h2 id=unit-tests-using-xunit-and-testcontainers>Unit Tests using xUnit and Testcontainers</h2><p>To ensure the correctness of the repository code, let&rsquo;s create unit tests using xUnit and Testcontainers. These tests will utilize a MongoDB container for testing purposes.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>OrderRepositoryTests</span> : IClassFixture&lt;MongoDbFixture&gt;
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>readonly</span> IMongoClient _client;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>readonly</span> OrderRepository _repository;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> OrderRepositoryTests(MongoDbFixture fixture)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        _client = fixture.Client;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> configuration = <span style=color:#66d9ef>new</span> ConfigurationBuilder().Build(); <span style=color:#75715e>// Add any necessary configurations for testing</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> options = Options.Create(<span style=color:#66d9ef>new</span> OrderRepositorySettings { OrderTtl = TimeSpan.FromHours(<span style=color:#ae81ff>1</span>) });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        _repository = <span style=color:#66d9ef>new</span> OrderRepository(_client, configuration, options);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span><span style=color:#a6e22e>
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>    [Fact]</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> CreateOrder_ShouldInsertOrderWithExpiration()
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Arrange</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> order = <span style=color:#66d9ef>new</span> Order { OrderNumber = <span style=color:#e6db74>&#34;123&#34;</span>, CreatedAt = DateTime.Now };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Act</span>
</span></span><span style=display:flex><span>        _repository.CreateOrder(order);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Assert</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> retrievedOrder = _client.GetDatabase(<span style=color:#e6db74>&#34;test&#34;</span>).GetCollection&lt;Order&gt;(<span style=color:#e6db74>&#34;orders&#34;</span>).Find(o =&gt; o.OrderNumber == <span style=color:#e6db74>&#34;123&#34;</span>).FirstOrDefault();
</span></span><span style=display:flex><span>        Assert.NotNull(retrievedOrder);
</span></span><span style=display:flex><span>        Assert.Equal(order.ExpireAt, retrievedOrder.ExpireAt);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Other test methods...</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>In the <code>OrderRepositoryTests</code> class, we use the <code>MongoDbFixture</code> to set up a MongoDB container for testing. The <code>CreateOrder_ShouldInsertOrderWithExpiration</code> test method validates that the order is inserted into the database with the correct expiration time.</p><p>This approach ensures that the repository code, including the TTL feature, works as expected in a controlled testing environment.</p><h2 id=verifying-the-ttl-implementation-in-mongodb-atlas-database>Verifying the TTL Implementation in MongoDB Atlas Database</h2><p>After implementing the TTL feature in your ASP.NET Core e-commerce system using MongoDB Atlas, it&rsquo;s crucial to verify that the TTL functionality works as expected. Here&rsquo;s a succinct guide on how to confirm the correct functioning of the example use case.</p><h3 id=prerequisites>Prerequisites</h3><ol><li><strong>MongoDB Atlas Account</strong>: Ensure you have access to a MongoDB Atlas account with a configured cluster.</li><li><strong>Connection String</strong>: Obtain the connection string for your MongoDB Atlas cluster.</li></ol><h3 id=steps-to-verify-ttl-implementation>Steps to Verify TTL Implementation</h3><ol><li><p><strong>Connect to MongoDB Atlas Cluster</strong>:</p><ul><li>Use the MongoDB shell or a tool like MongoDB Compass to connect to your MongoDB Atlas cluster using the provided connection string.</li></ul></li><li><p><strong>Select Database and Collection</strong>:</p><ul><li>Choose the database and collection where your orders are stored. In the case of the e-commerce system, this would be the &ldquo;orders&rdquo; collection in the selected database.</li></ul></li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>use YourDatabaseName
</span></span></code></pre></div><ol start=3><li><p><strong>Check TTL Index</strong>:</p><ul><li>Confirm that the TTL index has been created on the &ldquo;expireAt&rdquo; field.</li></ul></li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>db.orders.getIndexes<span style=color:#f92672>()</span>
</span></span></code></pre></div><ul><li>Ensure that an index similar to the following is present:</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;v&#34;</span>: <span style=color:#ae81ff>2</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;key&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;expireAt&#34;</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;expireAt_1&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;expireAfterSeconds&#34;</span>: <span style=color:#ae81ff>3600</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;background&#34;</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>The <code>expireAfterSeconds</code> value should match the TTL duration set in your application.</li></ul><ol start=4><li><p><strong>Insert Test Order</strong>:</p><ul><li>Insert a test order into the &ldquo;orders&rdquo; collection using the MongoDB shell or your preferred tool.</li></ul></li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>db.orders.insertOne<span style=color:#f92672>({</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;orderNumber&#34;</span>: <span style=color:#e6db74>&#34;test123&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;createdAt&#34;</span>: ISODate<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;2024-01-15T12:00:00Z&#34;</span><span style=color:#f92672>)</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;expireAt&#34;</span>: ISODate<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;2024-01-15T13:00:00Z&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#f92672>})</span>
</span></span></code></pre></div><ul><li>Adjust the timestamps based on your current time and the TTL duration.</li></ul><ol start=5><li><p><strong>Check Order Expiration</strong>:</p><ul><li>Monitor the &ldquo;orders&rdquo; collection to verify that the test order is automatically removed after the TTL duration.</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>db.orders.find<span style=color:#f92672>()</span>
</span></span></code></pre></div><ul><li>Confirm that the test order is no longer present in the collection after the specified TTL duration has elapsed.</li></ul></li></ol><h3 id=verification-summary>Verification Summary</h3><p>By following these steps, you can ensure that the TTL feature in MongoDB Atlas, as implemented in your ASP.NET Core e-commerce system, is working correctly. The TTL index, insertion of orders with expiration times, and automatic removal of expired orders should align with your expectations.</p><p>This verification process is crucial for maintaining data integrity and confirms that the TTL functionality effectively manages the lifecycle of documents in your MongoDB Atlas database.</p><h1 id=advantages-and-disadvantages>Advantages and Disadvantages</h1><h2 id=advantages>Advantages</h2><ul><li><strong>Automated Data Cleanup</strong>: TTL automates the process of removing stale data, reducing the need for manual cleanup tasks.</li><li><strong>Improved Performance</strong>: Eliminating expired data enhances database performance and reduces query times.</li></ul><h2 id=disadvantages>Disadvantages</h2><ul><li><strong>Overhead</strong>: Maintaining TTL indexes incurs additional overhead on the database, impacting write performance.</li><li><strong>Not Suitable for All Data</strong>: TTL is best suited for data with a clear expiration, and its implementation may not be optimal for all use cases.</li></ul><h1 id=issues-and-considerations>Issues and Considerations</h1><ul><li><strong>Index Size</strong>: The TTL index can grow significantly, affecting the overall database size.</li><li><strong>Impact on Write Performance</strong>: Frequent updates to documents with TTL indexes may result in increased write latencies.</li></ul><h1 id=when-to-use-and-when-not-to-use-ttl>When to Use and When Not to Use TTL</h1><p>Use TTL When:</p><ul><li><strong>Data has a Finite Lifespan</strong>: When documents in your collection have a clear expiration.</li><li><strong>Automated Cleanup is Preferred</strong>: For scenarios where manual data cleanup is impractical or inefficient.</li></ul><p>Avoid TTL When:</p><ul><li><strong>Data Retention is Critical</strong>: If retaining historical data is essential, TTL may not be suitable.</li><li><strong>Performance Impact is a Concern</strong>: In write-heavy applications where the overhead of maintaining TTL indexes could impact performance.</li></ul><h1 id=best-practices>Best Practices</h1><ul><li><strong>Monitor Index Size</strong>: Regularly monitor the size of TTL indexes to ensure they do not become a performance bottleneck.</li><li><strong>Choose Appropriate Expiration Strategy</strong>: Select the TTL expiration strategy based on the nature of the data in your collection.</li><li><strong>Consider Data Archiving</strong>: For scenarios requiring historical data, implement a data archiving strategy alongside or instead of TTL.</li></ul><h1 id=conclusion>Conclusion</h1><p>Implementing Time to Live (TTL) in MongoDB with ASP.NET Core can significantly enhance the efficiency of your applications, particularly in scenarios where data has a limited relevance period. However, careful consideration of the nature of the data, potential performance impacts, and adherence to best practices is crucial for successful implementation. By following the outlined guidelines and utilizing the provided code snippets, you can leverage MongoDB&rsquo;s TTL feature effectively in your ASP.NET Core applications.</p><h1 id=references>References:</h1><p><a href=https://www.mongodb.com/docs/manual/core/index-ttl/#ttl-indexes target=_blank>MongoDB Documentation - TTL Indexes</a>
<a href=https://www.mongodb.com/docs/drivers/csharp/current/#mongodb-c--driver target=_blank>MongoDB .NET Driver Documentation</a>
<a href=https://www.mongodb.com/products/tools/compass target=_blank>MongoDB Compass</a>
<a href=https://www.mongodb.com/docs/drivers/csharp/current/#mongodb-c--driver target=_blank>AutoMapper Documentation</a>
<a href=https://dotnet.testcontainers.org/ target=_blank>Testcontainers Documentation</a>
<a href=https://xunit.net/ target=_blank>xUnit Documentation</a></p><hr><div class=footer><p>This is a post in the <b><a href=https://gosang.github.io/series/data-store>Data Store</a></b> series.<br>Other posts in this series:<ul class=series><li>January 27, 2024 -
<a href=/posts/datastore/optimistic-concurrency-with-etag-in-asp-dotnet-core-8/>Optimistic Concurrency With Etag in ASP.NET Core 8</a></li><li>January 21, 2024 -
<a href=/posts/datastore/implementing-dapper-with-asp-dotnet-core-6/>Implementing Dapper With ASP.Core 6</a></li><li>January 20, 2024 -
<a href=/posts/datastore/implementing-entity-framework-core-6-with-asp.net-core-6/>Implementing Entity Framework Core 6 With ASP.NET Core 6</a></li><li>January 13, 2024 -
Implementing TTL (Time To Live) Feature in Mongodb Atlas With Dotnet Core</li><li>June 27, 2022 -
<a href=/posts/datastore/implementing-mongodb-atlas-with-dotnet-core-using-cqrs/>Implementing Mongodb Atlas With ASP.NET Core Using CQRS</a></li><li>March 27, 2022 -
<a href=/posts/datastore/mongodb-atlas-with-dotnet-core/>Mongodb Atlas With .NET Core</a></li></ul></p></div></div></main><div class=article-toc><div class=toc-wrapper><h4 id=contents></h4><nav id=TableOfContents><ul><li><a href=#what-is-ttl>What is TTL?</a></li><li><a href=#why-ttl-and-problem-resolution>Why TTL and Problem Resolution</a></li></ul><ul><li><a href=#1-expire-documents>1. Expire Documents</a></li><li><a href=#2-expire-documents-with-filter-conditions>2. Expire Documents with Filter Conditions</a></li><li><a href=#3-expire-documents-at-a-specific-clock-time>3. Expire Documents at a Specific Clock Time</a></li></ul><ul><li><a href=#example-use-case>Example Use Case</a></li><li><a href=#unit-tests-using-xunit-and-testcontainers>Unit Tests using xUnit and Testcontainers</a></li><li><a href=#verifying-the-ttl-implementation-in-mongodb-atlas-database>Verifying the TTL Implementation in MongoDB Atlas Database</a><ul><li><a href=#prerequisites>Prerequisites</a></li><li><a href=#steps-to-verify-ttl-implementation>Steps to Verify TTL Implementation</a></li><li><a href=#verification-summary>Verification Summary</a></li></ul></li></ul><ul><li><a href=#advantages>Advantages</a></li><li><a href=#disadvantages>Disadvantages</a></li></ul></nav></div></div></div></body></html>