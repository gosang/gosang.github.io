<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en-us lang=en-us><head><script defer language=javascript type=text/javascript src=/js/bundle.min.11d62625e7495f8147fccf5d08f37bded574a50c4508c235cc666848567d99ab.js></script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon href=/favicon.png><title itemprop=name>Go Sang - Simplifying OAuth 2 in Istio Proxy, Sidecar and Envoy Filter</title><meta property="og:title" content="Go Sang - Simplifying OAuth 2 in Istio Proxy, Sidecar and Envoy Filter"><meta name=twitter:title content="Go Sang - Simplifying OAuth 2 in Istio Proxy, Sidecar and Envoy Filter"><meta itemprop=name content="Go Sang - Simplifying OAuth 2 in Istio Proxy, Sidecar and Envoy Filter"><meta name=application-name content="Go Sang - Simplifying OAuth 2 in Istio Proxy, Sidecar and Envoy Filter"><meta property="og:site_name" content><meta name=description content><meta itemprop=description content><meta property="og:description" content><meta name=twitter:description content><base href=https://gosang.github.io/posts/istio/simplifying-oauth-2-in-istio-proxy-sidecar-and-envoy-filter/><link rel=canonical href=https://gosang.github.io/posts/istio/simplifying-oauth-2-in-istio-proxy-sidecar-and-envoy-filter/ itemprop=url><meta name=url content="https://gosang.github.io/posts/istio/simplifying-oauth-2-in-istio-proxy-sidecar-and-envoy-filter/"><meta name=twitter:url content="https://gosang.github.io/posts/istio/simplifying-oauth-2-in-istio-proxy-sidecar-and-envoy-filter/"><meta property="og:url" content="https://gosang.github.io/posts/istio/simplifying-oauth-2-in-istio-proxy-sidecar-and-envoy-filter/"><meta property="og:updated_time" content="7007-07-12T72:22:24+0100"><link rel=sitemap type=application/xml title=Sitemap href=https://gosang.github.io/sitemap.xml><meta name=robots content="index,follow"><meta name=googlebot content="index,follow"><meta name=twitter:site content><meta name=twitter:creator content><meta property="fb:admins" content><meta name=apple-mobile-web-app-title content><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="black"><meta property="og:type" content="article"><meta property="article:publisher" content><meta property="og:article:published_time" content="7007-07-12T72:22:24+0100"><meta property="article:published_time" content="7007-07-12T72:22:24+0100"><script defer type=application/ld+json>{"@context":"http://schema.org","@type":"Article","headline":"Simplifying OAuth 2 in Istio Proxy, Sidecar and Envoy Filter","author":{"@type":"Person","name":"https:\/\/github.com\/gosang"},"datePublished":"2024-07-07","description":"","wordCount":"1477","mainEntityOfPage":"True","dateModified":"2024-07-07","image":{"@type":"imageObject","url":""},"publisher":{"@type":"Organization","name":"","logo":{"@type":"imageObject","url":""}}}</script><meta name=generator content="Hugo 0.119.0"><link type=text/css rel=stylesheet href=/css/bundle.min.178e339ccb9acabffeebf9adbb0bb23c1ec0b72a2a50edee18a5007d4d5a68aa.css><style>body{--sidebar-bg-color:#202020;--sidebar-img-border-color:#515151;--sidebar-p-color:#909090;--sidebar-h1-color:#FFF;--sidebar-a-color:#FFF;--sidebar-socials-color:#FFF;--text-color:#222;--bkg-color:#FAF9F6;--post-title-color:#303030;--list-color:#5a5a5a;--link-color:#268bd2;--date-color:#515151;--table-border-color:#E5E5E5;--table-stripe-color:#F9F9F9;--code-color:#bf616a;--code-background-color:#E5E5E5;--moon-sun-color:#FFF;--moon-sun-background-color:#515151}body.dark-theme{--text-color:#eee;--bkg-color:#121212;--post-title-color:#DBE2E9;--list-color:#9d9d9d;--link-color:#268bd2;--date-color:#9a9a9a;--table-border-color:#515151;--table-stripe-color:#202020;--code-color:#ff7f7f;--code-background-color:#393D47}body{background-color:var(--bkg-color)}</style></head><body><div class=wrapper><aside class=sidebar><div class="container sidebar-sticky"><div class=light-dark align=right><button class=btn-light-dark title="Toggle light/dark mode"><svg class="moon" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 16 16"><path fill="currentcolor" d="M6 .278a.768.768.0 01.08.858 7.208 7.208.0 00-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527.0 1.04-.055 1.533-.16a.787.787.0 01.81.316.733.733.0 01-.031.893A8.349 8.349.0 018.344 16C3.734 16 0 12.286.0 7.71.0 4.266 2.114 1.312 5.124.06A.752.752.0 016 .278z"/></svg><svg class="sun" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 16 16"><path fill="currentcolor" d="M8 12a4 4 0 100-8 4 4 0 000 8zM8 0a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 0zm0 13a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 13zm8-5a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2a.5.5.0 01.5.5zM3 8a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2A.5.5.0 013 8zm10.657-5.657a.5.5.0 010 .707l-1.414 1.415a.5.5.0 11-.707-.708l1.414-1.414a.5.5.0 01.707.0zm-9.193 9.193a.5.5.0 010 .707L3.05 13.657a.5.5.0 01-.707-.707l1.414-1.414a.5.5.0 01.707.0zm9.193 2.121a.5.5.0 01-.707.0l-1.414-1.414a.5.5.0 01.707-.707l1.414 1.414a.5.5.0 010 .707zM4.464 4.465a.5.5.0 01-.707.0L2.343 3.05a.5.5.0 11.707-.707l1.414 1.414a.5.5.0 010 .708z"/></svg></button></div><div class=sidebar-about><h1 class=brand><a href=https://gosang.github.io/><h1>Go Sang</h1></a></h1><p class=lead>Learning about technology.</p></div><nav><ul class=sidebar-nav><li class=heading><a href=/posts/>Posts</a></li><li class=sub-heading>Recent</li><li class=bullet><a href=https://gosang.github.io/posts/react/implementing-cookie-based-stateless-sessions-in-next-js-using-server-actions/>Implementing Cookie-Based Stateless Sessions in Next.js Using Server Actions</a></li><li class=bullet><a href=https://gosang.github.io/posts/dotnet/sending-email-in-asp-dotnet-core-with-microsoft-graph/>Sending Email in ASP.NET Core With Microsoft Graph</a></li><li class=bullet><a href=https://gosang.github.io/posts/devops/kubernetes/using-multiple-namespaces-in-kubernetes/>Using Multiple Namespaces in Kubernetes</a></li><li class=bullet><a href=https://gosang.github.io/posts/react/simplifying-the-nextjs-server-actions/>Simplifying the Next.js Server Actions</a></li><li class=bullet><a href=https://gosang.github.io/posts/dotnet/result-pattern-in-asp-dotnet-core/>Result Pattern in ASP.NET Core</a></li></ul></nav><a target=_blank class=social title=GitHub href=https://github.com/gosang><svg xmlns="http://www.w3.org/2000/svg" width="1.2em" height="1.2em" viewBox="-2 -2 24 24"><path fill="currentcolor" d="M18.88 1.099C18.147.366 17.265.0 16.233.0H3.746C2.714.0 1.832.366 1.099 1.099.366 1.832.0 2.714.0 3.746v12.487c0 1.032.366 1.914 1.099 2.647.733.733 1.615 1.099 2.647 1.099H6.66c.19.0.333-.007.429-.02a.504.504.0 00.286-.169c.095-.1.143-.245.143-.435l-.007-.885c-.004-.564-.006-1.01-.006-1.34l-.3.052c-.19.035-.43.05-.721.046a5.555 5.555.0 01-.904-.091 2.026 2.026.0 01-.872-.39 1.651 1.651.0 01-.572-.8l-.13-.3a3.25 3.25.0 00-.41-.663c-.186-.243-.375-.407-.566-.494l-.09-.065a.956.956.0 01-.17-.156.723.723.0 01-.117-.182c-.026-.061-.004-.111.065-.15.07-.04.195-.059.378-.059l.26.04c.173.034.388.138.643.311a2.1 2.1.0 01.631.677c.2.355.44.626.722.813.282.186.566.28.852.28.286.0.533-.022.742-.065a2.59 2.59.0 00.585-.196c.078-.58.29-1.028.637-1.34a8.907 8.907.0 01-1.333-.234 5.314 5.314.0 01-1.223-.507 3.5 3.5.0 01-1.047-.872c-.277-.347-.505-.802-.683-1.365-.177-.564-.266-1.215-.266-1.952.0-1.049.342-1.942 1.027-2.68-.32-.788-.29-1.673.091-2.652.252-.079.625-.02 1.119.175.494.195.856.362 1.086.5.23.14.414.257.553.352a9.233 9.233.0 012.497-.338c.859.0 1.691.113 2.498.338l.494-.312a6.997 6.997.0 011.197-.572c.46-.174.81-.221 1.054-.143.39.98.424 1.864.103 2.653.685.737 1.028 1.63 1.028 2.68.0.737-.089 1.39-.267 1.957-.177.568-.407 1.023-.689 1.366a3.65 3.65.0 01-1.053.865c-.42.234-.828.403-1.223.507a8.9 8.9.0 01-1.333.235c.45.39.676 1.005.676 1.846v3.11c0 .147.021.266.065.357a.36.36.0 00.208.189c.096.034.18.056.254.064.074.01.18.013.318.013h2.914c1.032.0 1.914-.366 2.647-1.099.732-.732 1.099-1.615 1.099-2.647V3.746c0-1.032-.367-1.914-1.1-2.647z"/></svg></a><a target=_blank class=social title="RSS Feed" href=https://gosang.github.io//posts/index.xml><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1.2em" viewBox="0 0 1280 1280"><g transform="translate(0.000000,1280.000000) scale(0.100000,-0.100000)" fill="currentcolor"><path d="M2295 11929c-284-12-642-45-707-65-17-5-18-63-18-1039 0-569 4-1036 8-1039 5-3 74 6 153 19 510 86 1168 95 1789 25 1348-153 2602-677 3670-1531 385-308 820-744 1126-1129 842-1060 1362-2313 1514-3650 70-621 61-1279-25-1789-13-79-22-148-19-153 3-4 471-8 1039-8h1035l5 23c51 225 85 942 67 1419-23 605-77 1044-198 1617-294 14e2-927 2734-1823 3846-1043 1295-2364 2259-3909 2854-1158 447-2451 656-3707 6e2z"/><path d="M2255 7845c-269-25-620-81-667-106-17-9-18-55-18-899 0-706 3-890 13-890 6 0 66 18 132 41 130 44 288 79 467 105 154 21 577 30 749 15 1207-107 2267-823 2814-1902 166-327 268-637 330-1001 38-227 48-384 42-662-8-348-44-590-126-831-23-66-41-126-41-132 0-10 184-13 890-13 844 0 890 1 899 18 27 50 88 452 110 725 14 162 14 624 1 782-59 703-233 1323-545 1945-481 956-1313 1788-2270 2268-620 310-1239 483-1940 542-165 14-669 10-840-5z"/><path d="M2519 3815c-391-66-725-336-868-703-79-201-96-462-45-677 83-344 338-641 666-774 116-47 205-69 330-80 412-39 811 153 1040 5e2 193 292 240 648 128 981-135 403-492 699-914 757-1e2 14-241 12-337-4z"/></g></svg></a><p class=footnote>powered by <a target=_blank href=https://gohugo.io>Hugo</a> | themed with <a target=_blank href=https://github.com/lukeorth/poison>poison</a><br>&copy; 2024 . All rights reserved.</p></div></aside><main class="content container"><div class=post><div class=info><h1 class=post-title><a href=https://gosang.github.io/posts/istio/simplifying-oauth-2-in-istio-proxy-sidecar-and-envoy-filter/>Simplifying OAuth 2 in Istio Proxy, Sidecar and Envoy Filter</a></h1><time datetime=2024-07-07T12:02:22+0100 class=post-date>July 7, 2024</time><ul class=tags><li class=tag-Istio><a href=https://gosang.github.io/tags/istio>Istio</a></li><li class="tag-OAuth 2.0"><a href=https://gosang.github.io/tags/oauth-2.0>OAuth 2.0</a></li></ul></div><p>In the context of microservices and cloud-native applications, securing APIs and ensuring proper authentication are critical. OAuth 2.0 is a widely adopted authorization framework designed to provide secure access to resources. When working with Istio, a popular service mesh for managing microservices, integrating OAuth 2.0 can be achieved through various mechanisms such as OAuth 2.0 Proxy, OAuth 2.0 Sidecar Proxy, and OAuth 2.0 Envoy Filter. This blog aims to explain these concepts, their rationale, main functions, sample implementation with Keycloak as an Identity Provider, and provide guidance on their use cases.</p><h1 id=what-is-istio>What is Istio?</h1><p>Istio is an open-source service mesh that provides a uniform way to secure, connect, and observe microservices. It works by deploying a network of proxies (Envoy) alongside microservices, handling the inter-service communication. Istio offers capabilities such as traffic management, security, and observability without requiring changes to the application code.</p><h1 id=what-is-oauth-20>What is OAuth 2.0?</h1><p>OAuth 2.0 is an authorization framework that allows applications to obtain limited access to user accounts on an HTTP service. It works by delegating user authentication to the service that hosts the user account and authorizing third-party applications to access the user account. The primary components include:</p><ul><li><strong>Resource Owner</strong>: The user who authorizes an application to access their account.</li><li><strong>Client</strong>: The application requesting access to the user’s account.</li><li><strong>Authorization Server</strong>: The server issuing access tokens to the client after successfully authenticating the resource owner.</li><li><strong>Resource Server</strong>: The server hosting the protected resources, accepting and responding to protected resource requests using access tokens.</li></ul><h1 id=oauth-20-proxy-sidecar-proxy-and-envoy-filter-in-istio>OAuth 2.0 Proxy, Sidecar Proxy, and Envoy Filter in Istio</h1><h2 id=oauth-20-proxy>OAuth 2.0 Proxy</h2><p>An OAuth 2.0 Proxy acts as an intermediary between the client and the backend services. It handles the OAuth 2.0 flow, authenticating users and injecting tokens into requests.</p><h3 id=rationale-and-key-functions>Rationale and Key Functions:</h3><ul><li>Centralized authentication handling.</li><li>Simplifies integrating OAuth 2.0 for applications.</li><li>Manages token refresh and validation.</li></ul><h2 id=oauth-20-sidecar-proxy>OAuth 2.0 Sidecar Proxy</h2><p>The Sidecar Proxy is a pattern where an OAuth 2.0 proxy is deployed alongside each application instance. This sidecar container intercepts traffic to and from the application, managing OAuth 2.0 authentication.</p><h3 id=rationale-and-key-functions-1>Rationale and Key Functions:</h3><ul><li>Provides isolation between application code and authentication logic.</li><li>Allows for per-service authentication policies.</li><li>Simplifies scaling and maintenance.</li></ul><h2 id=oauth-20-envoy-filter>OAuth 2.0 Envoy Filter</h2><p>An OAuth 2.0 Envoy Filter is a custom filter applied in the Envoy proxies managed by Istio. This filter enforces OAuth 2.0 authentication on incoming requests at the ingress or within the service mesh.</p><h3 id=rationale-and-key-functions-2>Rationale and Key Functions:</h3><ul><li>Deeply integrated with Istio’s traffic management.</li><li>Centralized policy enforcement at the ingress gateway.</li><li>Reduces operational overhead by leveraging Istio’s control plane.</li></ul><h1 id=implementing-oauth-20-in-istio-with-keycloak>Implementing OAuth 2.0 in Istio with Keycloak</h1><h2 id=prerequisites>Prerequisites</h2><ul><li>Istio installed and configured.</li><li>Keycloak server set up as the Identity Provider.</li><li>Two sample .NET Core 8 APIs.</li><li>OAuth 2.0 Proxy Implementation</li></ul><h2 id=deploy-oauth-20-proxy>Deploy OAuth 2.0 Proxy</h2><p>Create a <code>deployment-oauth2-proxy.yaml</code> file with the following content:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>apps/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Deployment</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>oauth2-proxy</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>replicas</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>matchLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>app</span>: <span style=color:#ae81ff>oauth2-proxy</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>app</span>: <span style=color:#ae81ff>oauth2-proxy</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>oauth2-proxy</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>image</span>: <span style=color:#ae81ff>quay.io/oauth2-proxy/oauth2-proxy:v7.1.3</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>args</span>:
</span></span><span style=display:flex><span>            - --<span style=color:#ae81ff>provider=keycloak</span>
</span></span><span style=display:flex><span>            - --<span style=color:#ae81ff>keycloak-issuer-url=https://keycloak.example.com/auth/realms/myrealm</span>
</span></span><span style=display:flex><span>            - --<span style=color:#ae81ff>client-id=myclient</span>
</span></span><span style=display:flex><span>            - --<span style=color:#ae81ff>client-secret=mysecret</span>
</span></span><span style=display:flex><span>            - --<span style=color:#ae81ff>upstream=http://myapi:8080</span>
</span></span><span style=display:flex><span>            - --<span style=color:#ae81ff>cookie-secret=asecrethash</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>            - <span style=color:#f92672>containerPort</span>: <span style=color:#ae81ff>4180</span>
</span></span></code></pre></div><p>This YAML file defines a Kubernetes deployment for the OAuth2 Proxy. It configures the proxy to use Keycloak as the OAuth2 provider and specifies the upstream service (your backend API) and the necessary secrets.</p><h3 id=apply-the-deployment>Apply the deployment:</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kubectl apply -f deployment-oauth2-proxy.yaml
</span></span></code></pre></div><h2 id=configure-istio-ingress-gateway>Configure Istio Ingress Gateway</h2><p>Create an <code>ingress-gateway.yaml</code> file with the following content:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>networking.istio.io/v1beta1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Gateway</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>mygateway</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>istio</span>: <span style=color:#ae81ff>ingressgateway</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>servers</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>port</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>number</span>: <span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>http</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>protocol</span>: <span style=color:#ae81ff>HTTP</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>hosts</span>:
</span></span><span style=display:flex><span>        - <span style=color:#e6db74>&#34;*&#34;</span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>networking.istio.io/v1beta1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>VirtualService</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>myapi</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>gateways</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>mygateway</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>:
</span></span><span style=display:flex><span>    - <span style=color:#e6db74>&#34;*&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>http</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>route</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>destination</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>host</span>: <span style=color:#ae81ff>oauth2-proxy</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>port</span>:
</span></span><span style=display:flex><span>              <span style=color:#f92672>number</span>: <span style=color:#ae81ff>4180</span>
</span></span></code></pre></div><p>This configuration creates an Istio Gateway and a VirtualService. The Gateway defines the entry point for external traffic, while the VirtualService routes incoming traffic to the OAuth2 Proxy.</p><h3 id=apply-the-configuration>Apply the configuration:</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kubectl apply -f ingress-gateway.yaml
</span></span></code></pre></div><ul><li><strong>Gateway</strong>: Defines the external access point to the mesh. Here, it&rsquo;s configured to accept HTTP traffic on port 80 for all hosts (*).</li><li><strong>VirtualService</strong>: Routes incoming requests to the OAuth2 Proxy service, which handles authentication before forwarding requests to the backend API.</li></ul><h2 id=oauth-20-sidecar-proxy-implementation>OAuth 2.0 Sidecar Proxy Implementation</h2><h3 id=create-a-deployment-sidecar-proxyyaml-file>Create a <code>deployment-sidecar-proxy.yaml</code> file:</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>apps/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Deployment</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>myapi</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>replicas</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>matchLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>app</span>: <span style=color:#ae81ff>myapi</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>app</span>: <span style=color:#ae81ff>myapi</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>myapi</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>image</span>: <span style=color:#ae81ff>myapi:latest</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>            - <span style=color:#f92672>containerPort</span>: <span style=color:#ae81ff>8080</span>
</span></span><span style=display:flex><span>        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>oauth2-proxy</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>image</span>: <span style=color:#ae81ff>quay.io/oauth2-proxy/oauth2-proxy:v7.1.3</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>args</span>:
</span></span><span style=display:flex><span>            - --<span style=color:#ae81ff>provider=keycloak</span>
</span></span><span style=display:flex><span>            - --<span style=color:#ae81ff>keycloak-issuer-url=https://keycloak.example.com/auth/realms/myrealm</span>
</span></span><span style=display:flex><span>            - --<span style=color:#ae81ff>client-id=myclient</span>
</span></span><span style=display:flex><span>            - --<span style=color:#ae81ff>client-secret=mysecret</span>
</span></span><span style=display:flex><span>            - --<span style=color:#ae81ff>upstream=http://localhost:8080</span>
</span></span><span style=display:flex><span>            - --<span style=color:#ae81ff>cookie-secret=asecrethash</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>            - <span style=color:#f92672>containerPort</span>: <span style=color:#ae81ff>4180</span>
</span></span></code></pre></div><p>This YAML defines a deployment for your application (myapi) with an OAuth2 Proxy sidecar container. The sidecar proxy is configured to handle authentication for requests to the application.</p><h3 id=apply-the-deployment-1>Apply the deployment:</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kubectl apply -f deployment-sidecar-proxy.yaml
</span></span></code></pre></div><h2 id=service-and-virtualservice-configuration>Service and VirtualService Configuration</h2><p>Create a <code>service-virtualservice.yaml</code> file:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Service</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>myapi</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>myapi</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>protocol</span>: <span style=color:#ae81ff>TCP</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>port</span>: <span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>targetPort</span>: <span style=color:#ae81ff>4180</span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>networking.istio.io/v1beta1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>VirtualService</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>myapi</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>:
</span></span><span style=display:flex><span>    - <span style=color:#e6db74>&#34;*&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>gateways</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>mygateway</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>http</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>match</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>uri</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>prefix</span>: <span style=color:#ae81ff>/api</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>route</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>destination</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>host</span>: <span style=color:#ae81ff>myapi</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>port</span>:
</span></span><span style=display:flex><span>              <span style=color:#f92672>number</span>: <span style=color:#ae81ff>80</span>
</span></span></code></pre></div><p>This configuration defines a Kubernetes Service for myapi and a VirtualService that routes traffic through the OAuth2 Proxy sidecar.</p><h3 id=apply-the-configuration-1>Apply the configuration:</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kubectl apply -f service-virtualservice.yaml
</span></span></code></pre></div><ul><li><strong>Service</strong>: Exposes the application, forwarding traffic to the OAuth2 Proxy sidecar on port 4180.</li><li><strong>VirtualService</strong>: Routes requests matching the /api prefix to the myapi service, which handles authentication via the sidecar proxy.</li></ul><h2 id=oauth-20-envoy-filter-implementation>OAuth 2.0 Envoy Filter Implementation</h2><p>Create an <code>envoy-filter.yaml</code> file</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>networking.istio.io/v1alpha3</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>EnvoyFilter</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>oauth2-filter</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>workloadSelector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>app</span>: <span style=color:#ae81ff>myapi</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>configPatches</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>applyTo</span>: <span style=color:#ae81ff>HTTP_FILTER</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>match</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>context</span>: <span style=color:#ae81ff>SIDECAR_INBOUND</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>listener</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>filterChain</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>filter</span>:
</span></span><span style=display:flex><span>              <span style=color:#f92672>name</span>: <span style=color:#ae81ff>envoy.filters.network.http_connection_manager</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>patch</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>operation</span>: <span style=color:#ae81ff>INSERT_BEFORE</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>value</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>name</span>: <span style=color:#ae81ff>envoy.filters.http.jwt_authn</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>config</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>providers</span>:
</span></span><span style=display:flex><span>              <span style=color:#f92672>keycloak</span>:
</span></span><span style=display:flex><span>                <span style=color:#f92672>issuer</span>: <span style=color:#ae81ff>https://keycloak.example.com/auth/realms/myrealm</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>remote_jwks</span>:
</span></span><span style=display:flex><span>                  <span style=color:#f92672>http_uri</span>:
</span></span><span style=display:flex><span>                    <span style=color:#f92672>uri</span>: <span style=color:#ae81ff>https://keycloak.example.com/auth/realms/myrealm/protocol/openid-connect/certs</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>cluster</span>: <span style=color:#ae81ff>jwt_cluster</span>
</span></span><span style=display:flex><span>                  <span style=color:#f92672>cache_duration</span>:
</span></span><span style=display:flex><span>                    <span style=color:#f92672>seconds</span>: <span style=color:#ae81ff>600</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>rules</span>:
</span></span><span style=display:flex><span>              - <span style=color:#f92672>match</span>:
</span></span><span style=display:flex><span>                  <span style=color:#f92672>prefix</span>: <span style=color:#e6db74>&#34;/&#34;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>requires</span>:
</span></span><span style=display:flex><span>                  <span style=color:#f92672>provider_name</span>: <span style=color:#e6db74>&#34;keycloak&#34;</span>
</span></span></code></pre></div><p>This YAML defines an EnvoyFilter that inserts a JWT authentication filter into the Envoy proxy&rsquo;s filter chain. The filter enforces authentication using tokens issued by Keycloak.</p><h3 id=apply-the-configuration-2>Apply the configuration:</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kubectl apply -f envoy-filter.yaml
</span></span></code></pre></div><h2 id=serviceentry-for-keycloak>ServiceEntry for Keycloak</h2><p>Create a <code>service-entry.yaml</code> file:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>networking.istio.io/v1alpha3</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ServiceEntry</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>keycloak</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>:
</span></span><span style=display:flex><span>    - <span style=color:#e6db74>&#34;keycloak.example.com&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>number</span>: <span style=color:#ae81ff>443</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>name</span>: <span style=color:#ae81ff>https</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>protocol</span>: <span style=color:#ae81ff>HTTPS</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>resolution</span>: <span style=color:#ae81ff>DNS</span>
</span></span></code></pre></div><p>This YAML defines a ServiceEntry that allows Istio to route traffic to the Keycloak server.</p><h3 id=apply-the-configuration-3>Apply the configuration:</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kubectl apply -f service-entry.yaml
</span></span></code></pre></div><ul><li><strong>EnvoyFilter</strong>: Adds a custom filter to the Envoy proxy to enforce OAuth2 authentication using JWTs from Keycloak.</li><li><strong>ServiceEntry</strong>: Configures Istio to recognize the Keycloak server and route traffic to it.</li></ul><h1 id=advantages-and-disadvantages>Advantages and Disadvantages</h1><table><thead><tr><th>Approach</th><th>Advantages</th><th>Disadvantages</th></tr></thead><tbody><tr><td>OAuth 2.0 Proxy</td><td>Centralizes authentication handling.</td><td>Single point of failure.</td></tr><tr><td></td><td>Simplifies application code by offloading authentication tasks.</td><td>May introduce latency.</td></tr><tr><td>OAuth 2.0 Sidecar Proxy</td><td>Isolates authentication logic from application code.</td><td>Increased resource consumption.</td></tr><tr><td></td><td>Flexible and scalable.</td><td>Complex deployment and management.</td></tr><tr><td>OAuth 2.0 Envoy Filter</td><td>Deep integration with Istio.</td><td>Steeper learning curve.</td></tr><tr><td></td><td>Centralized policy enforcement.</td><td>Debugging can be challenging.</td></tr><tr><td></td><td>Minimal changes to application code.</td><td></td></tr></tbody></table><h1 id=when-to-use-each-approach>When to Use Each Approach</h1><table><thead><tr><th>Approach</th><th>When to use</th><th>When not to use</th></tr></thead><tbody><tr><td>OAuth 2.0 Proxy</td><td>Use when you want a simple and centralized way to manage authentication without changing application code.</td><td>Avoid if you have high availability requirements or need low-latency solutions.</td></tr><tr><td>OAuth 2.0 Sidecar Proxy</td><td>Use for microservices requiring isolated authentication logic and where scalability is a concern.</td><td>Avoid if resource overhead is a significant issue.</td></tr><tr><td>OAuth 2.0 Envoy Filter</td><td>Use for complex environments where deep integration with Istio is beneficial, and centralized policy enforcement is needed.</td><td>Avoid if team lacks expertise in Istio or when rapid debugging is required.</td></tr></tbody></table><h1 id=issues-considerations-and-best-practices>Issues, Considerations, and Best Practices</h1><ul><li><strong>Security</strong><ul><li>Ensure secure storage of client secrets.</li><li>Use HTTPS for all communications.</li><li>Regularly update and patch OAuth 2.0 proxies and filters.</li></ul></li><li><strong>Token Management</strong><ul><li>Ensure proper handling of token expiration and refresh.</li></ul></li><li><strong>Performance</strong><ul><li>Monitor the performance impact of additional proxies.</li><li>Optimize configurations to reduce latency.</li></ul></li><li><strong>Scalability</strong><ul><li>Plan for horizontal scaling, especially for sidecar proxies.</li><li>Use appropriate resource limits for sidecar containers.</li></ul></li><li><strong>Maintenance</strong><ul><li>Automate deployment and updates using CI/CD pipelines.</li><li>Maintain version control for configuration files.</li></ul></li><li><strong>Logging and Monitoring</strong><ul><li>Implement robust logging and monitoring for all OAuth 2.0 components.</li><li>Implement comprehensive monitoring for proxies and filters.</li><li>Use centralized logging solutions for easier troubleshooting.</li></ul></li></ul><h1 id=conclusion>Conclusion</h1><p>Implementing OAuth 2.0 in Istio provides robust authentication mechanisms for securing APIs. The choice between OAuth 2.0 Proxy, OAuth 2.0 Sidecar Proxy, and OAuth 2.0 Envoy Filter depends on your specific requirements, such as centralization, isolation, or deep integration with Istio. Each approach has its own advantages and disadvantages:</p><ul><li><strong>OAuth 2.0 Proxy</strong>: Best for simple, centralized authentication but introduces additional proxy layers.</li><li><strong>OAuth 2.0 Sidecar Proxy</strong>: Offers isolation and per-service policies but increases resource consumption.</li><li><strong>OAuth 2.0 Envoy Filter</strong>: Provides centralized policy enforcement with reduced overhead but requires more complex configuration.</li></ul><p>By understanding these approaches and their trade-offs, you can effectively secure your APIs in Istio with OAuth 2.0, providing a robust and scalable authentication solution.</p><h1 id=references>References</h1><ul><li><a href=https://istio.io/latest/docs/ target=_blank>Istio Documentation</a></li><li><a href=https://github.com/oauth2-proxy/oauth2-proxy target=_blank>OAuth2 Proxy GitHub</a></li><li><a href=https://www.keycloak.org/documentation target=_blank>Keycloak Documentation</a></li></ul><hr><div class=footer><a class=previous-post href="https://gosang.github.io/posts/dotnet/using-quartz-dotnet-with-asp-dotnet-core-and-worker-services/?ref=footer"><span style=font-weight:700>« Previous</span><br>Using Quartz.NET with ASP.NET Core and Worker...</a><div class=next-post><a href="https://gosang.github.io/posts/security/simplifying-cookie-based-and-token-based-authentication/?ref=footer"><span style=font-weight:700>Next »</span><br>Simplifying Cookie-based and Token-based...</a></div></div></div></main><div class=article-toc><div class=toc-wrapper><h4 id=contents></h4><nav id=TableOfContents><ul><li><a href=#oauth-20-proxy>OAuth 2.0 Proxy</a><ul><li><a href=#rationale-and-key-functions>Rationale and Key Functions:</a></li></ul></li><li><a href=#oauth-20-sidecar-proxy>OAuth 2.0 Sidecar Proxy</a><ul><li><a href=#rationale-and-key-functions-1>Rationale and Key Functions:</a></li></ul></li><li><a href=#oauth-20-envoy-filter>OAuth 2.0 Envoy Filter</a><ul><li><a href=#rationale-and-key-functions-2>Rationale and Key Functions:</a></li></ul></li></ul><ul><li><a href=#prerequisites>Prerequisites</a></li><li><a href=#deploy-oauth-20-proxy>Deploy OAuth 2.0 Proxy</a><ul><li><a href=#apply-the-deployment>Apply the deployment:</a></li></ul></li><li><a href=#configure-istio-ingress-gateway>Configure Istio Ingress Gateway</a><ul><li><a href=#apply-the-configuration>Apply the configuration:</a></li></ul></li><li><a href=#oauth-20-sidecar-proxy-implementation>OAuth 2.0 Sidecar Proxy Implementation</a><ul><li><a href=#create-a-deployment-sidecar-proxyyaml-file>Create a <code>deployment-sidecar-proxy.yaml</code> file:</a></li><li><a href=#apply-the-deployment-1>Apply the deployment:</a></li></ul></li><li><a href=#service-and-virtualservice-configuration>Service and VirtualService Configuration</a><ul><li><a href=#apply-the-configuration-1>Apply the configuration:</a></li></ul></li><li><a href=#oauth-20-envoy-filter-implementation>OAuth 2.0 Envoy Filter Implementation</a><ul><li><a href=#apply-the-configuration-2>Apply the configuration:</a></li></ul></li><li><a href=#serviceentry-for-keycloak>ServiceEntry for Keycloak</a><ul><li><a href=#apply-the-configuration-3>Apply the configuration:</a></li></ul></li></ul></nav></div></div></div></body></html>