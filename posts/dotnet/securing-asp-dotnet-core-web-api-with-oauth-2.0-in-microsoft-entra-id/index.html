<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en-us lang=en-us><head><script defer language=javascript type=text/javascript src=/js/bundle.min.11d62625e7495f8147fccf5d08f37bded574a50c4508c235cc666848567d99ab.js></script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon href=/favicon.png><title itemprop=name>Go Sang - Securing ASP.NET Core Web API With OAuth 2.0 in Microsoft Entra ID</title><meta property="og:title" content="Go Sang - Securing ASP.NET Core Web API With OAuth 2.0 in Microsoft Entra ID"><meta name=twitter:title content="Go Sang - Securing ASP.NET Core Web API With OAuth 2.0 in Microsoft Entra ID"><meta itemprop=name content="Go Sang - Securing ASP.NET Core Web API With OAuth 2.0 in Microsoft Entra ID"><meta name=application-name content="Go Sang - Securing ASP.NET Core Web API With OAuth 2.0 in Microsoft Entra ID"><meta property="og:site_name" content><meta name=description content><meta itemprop=description content><meta property="og:description" content><meta name=twitter:description content><base href=https://gosang.github.io/posts/dotnet/securing-asp-dotnet-core-web-api-with-oauth-2.0-in-microsoft-entra-id/><link rel=canonical href=https://gosang.github.io/posts/dotnet/securing-asp-dotnet-core-web-api-with-oauth-2.0-in-microsoft-entra-id/ itemprop=url><meta name=url content="https://gosang.github.io/posts/dotnet/securing-asp-dotnet-core-web-api-with-oauth-2.0-in-microsoft-entra-id/"><meta name=twitter:url content="https://gosang.github.io/posts/dotnet/securing-asp-dotnet-core-web-api-with-oauth-2.0-in-microsoft-entra-id/"><meta property="og:url" content="https://gosang.github.io/posts/dotnet/securing-asp-dotnet-core-web-api-with-oauth-2.0-in-microsoft-entra-id/"><meta property="og:updated_time" content="28001-28-02T122:05:24Z"><link rel=sitemap type=application/xml title=Sitemap href=https://gosang.github.io/sitemap.xml><meta name=robots content="index,follow"><meta name=googlebot content="index,follow"><meta name=twitter:site content><meta name=twitter:creator content><meta property="fb:admins" content><meta name=apple-mobile-web-app-title content><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="black"><meta property="og:type" content="article"><meta property="article:publisher" content><meta property="og:article:published_time" content="28001-28-02T122:05:24Z"><meta property="article:published_time" content="28001-28-02T122:05:24Z"><script defer type=application/ld+json>{"@context":"http://schema.org","@type":"Article","headline":"Securing ASP.NET Core Web API With OAuth 2.0 in Microsoft Entra ID","author":{"@type":"Person","name":"https:\/\/github.com\/gosang"},"datePublished":"2024-01-28","description":"","wordCount":"1308","mainEntityOfPage":"True","dateModified":"2024-01-28","image":{"@type":"imageObject","url":""},"publisher":{"@type":"Organization","name":"","logo":{"@type":"imageObject","url":""}}}</script><meta name=generator content="Hugo 0.119.0"><link type=text/css rel=stylesheet href=/css/bundle.min.178e339ccb9acabffeebf9adbb0bb23c1ec0b72a2a50edee18a5007d4d5a68aa.css><style>body{--sidebar-bg-color:#202020;--sidebar-img-border-color:#515151;--sidebar-p-color:#909090;--sidebar-h1-color:#FFF;--sidebar-a-color:#FFF;--sidebar-socials-color:#FFF;--text-color:#222;--bkg-color:#FAF9F6;--post-title-color:#303030;--list-color:#5a5a5a;--link-color:#268bd2;--date-color:#515151;--table-border-color:#E5E5E5;--table-stripe-color:#F9F9F9;--code-color:#bf616a;--code-background-color:#E5E5E5;--moon-sun-color:#FFF;--moon-sun-background-color:#515151}body.dark-theme{--text-color:#eee;--bkg-color:#121212;--post-title-color:#DBE2E9;--list-color:#9d9d9d;--link-color:#268bd2;--date-color:#9a9a9a;--table-border-color:#515151;--table-stripe-color:#202020;--code-color:#ff7f7f;--code-background-color:#393D47}body{background-color:var(--bkg-color)}</style></head><body><div class=wrapper><aside class=sidebar><div class="container sidebar-sticky"><div class=light-dark align=right><button class=btn-light-dark title="Toggle light/dark mode"><svg class="moon" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 16 16"><path fill="currentcolor" d="M6 .278a.768.768.0 01.08.858 7.208 7.208.0 00-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527.0 1.04-.055 1.533-.16a.787.787.0 01.81.316.733.733.0 01-.031.893A8.349 8.349.0 018.344 16C3.734 16 0 12.286.0 7.71.0 4.266 2.114 1.312 5.124.06A.752.752.0 016 .278z"/></svg><svg class="sun" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 16 16"><path fill="currentcolor" d="M8 12a4 4 0 100-8 4 4 0 000 8zM8 0a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 0zm0 13a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 13zm8-5a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2a.5.5.0 01.5.5zM3 8a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2A.5.5.0 013 8zm10.657-5.657a.5.5.0 010 .707l-1.414 1.415a.5.5.0 11-.707-.708l1.414-1.414a.5.5.0 01.707.0zm-9.193 9.193a.5.5.0 010 .707L3.05 13.657a.5.5.0 01-.707-.707l1.414-1.414a.5.5.0 01.707.0zm9.193 2.121a.5.5.0 01-.707.0l-1.414-1.414a.5.5.0 01.707-.707l1.414 1.414a.5.5.0 010 .707zM4.464 4.465a.5.5.0 01-.707.0L2.343 3.05a.5.5.0 11.707-.707l1.414 1.414a.5.5.0 010 .708z"/></svg></button></div><div class=sidebar-about><h1 class=brand><a href=https://gosang.github.io/><h1>Go Sang</h1></a></h1><p class=lead>Learning about technology.</p></div><nav><ul class=sidebar-nav><li class=heading><a href=/posts/>Posts</a></li><li class=sub-heading>Recent</li><li class=bullet><a href=https://gosang.github.io/posts/dotnet/understanding-action-func-and-predicate-delegate-types-in-asp.net-core-8/>Understanding the Action, Func and Predicate Delegate Types in ASP.NET Core 8</a></li><li class=bullet><a href=https://gosang.github.io/posts/design-patterns/the-twelve-factor-app-a-modern-approach-to-software-delivery/>The Twelve-Factor App: A Modern Approach to Software Delivery</a></li><li class=bullet><a href=https://gosang.github.io/posts/devops/kubernetes/deploying-applications-with-helm-simplifying-kubernetes-orchestration/>Deploying Applications With Helm: Simplifying Kubernetes Orchestration</a></li><li class=bullet><a href=https://gosang.github.io/posts/devops/kubernetes/configuring-resources-with-yaml-manifests-in-kubernetes/>Configuring Resources With YAML Manifests in Kubernetes</a></li><li class=bullet><a href=https://gosang.github.io/posts/devops/kubernetes/understanding-kubernetes-a-developer-guide/>Understanding Kubernetes: A Developer`s Guide</a></li></ul></nav><a target=_blank class=social title=GitHub href=https://github.com/gosang><svg xmlns="http://www.w3.org/2000/svg" width="1.2em" height="1.2em" viewBox="-2 -2 24 24"><path fill="currentcolor" d="M18.88 1.099C18.147.366 17.265.0 16.233.0H3.746C2.714.0 1.832.366 1.099 1.099.366 1.832.0 2.714.0 3.746v12.487c0 1.032.366 1.914 1.099 2.647.733.733 1.615 1.099 2.647 1.099H6.66c.19.0.333-.007.429-.02a.504.504.0 00.286-.169c.095-.1.143-.245.143-.435l-.007-.885c-.004-.564-.006-1.01-.006-1.34l-.3.052c-.19.035-.43.05-.721.046a5.555 5.555.0 01-.904-.091 2.026 2.026.0 01-.872-.39 1.651 1.651.0 01-.572-.8l-.13-.3a3.25 3.25.0 00-.41-.663c-.186-.243-.375-.407-.566-.494l-.09-.065a.956.956.0 01-.17-.156.723.723.0 01-.117-.182c-.026-.061-.004-.111.065-.15.07-.04.195-.059.378-.059l.26.04c.173.034.388.138.643.311a2.1 2.1.0 01.631.677c.2.355.44.626.722.813.282.186.566.28.852.28.286.0.533-.022.742-.065a2.59 2.59.0 00.585-.196c.078-.58.29-1.028.637-1.34a8.907 8.907.0 01-1.333-.234 5.314 5.314.0 01-1.223-.507 3.5 3.5.0 01-1.047-.872c-.277-.347-.505-.802-.683-1.365-.177-.564-.266-1.215-.266-1.952.0-1.049.342-1.942 1.027-2.68-.32-.788-.29-1.673.091-2.652.252-.079.625-.02 1.119.175.494.195.856.362 1.086.5.23.14.414.257.553.352a9.233 9.233.0 012.497-.338c.859.0 1.691.113 2.498.338l.494-.312a6.997 6.997.0 011.197-.572c.46-.174.81-.221 1.054-.143.39.98.424 1.864.103 2.653.685.737 1.028 1.63 1.028 2.68.0.737-.089 1.39-.267 1.957-.177.568-.407 1.023-.689 1.366a3.65 3.65.0 01-1.053.865c-.42.234-.828.403-1.223.507a8.9 8.9.0 01-1.333.235c.45.39.676 1.005.676 1.846v3.11c0 .147.021.266.065.357a.36.36.0 00.208.189c.096.034.18.056.254.064.074.01.18.013.318.013h2.914c1.032.0 1.914-.366 2.647-1.099.732-.732 1.099-1.615 1.099-2.647V3.746c0-1.032-.367-1.914-1.1-2.647z"/></svg></a><a target=_blank class=social title="RSS Feed" href=https://gosang.github.io//posts/index.xml><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1.2em" viewBox="0 0 1280 1280"><g transform="translate(0.000000,1280.000000) scale(0.100000,-0.100000)" fill="currentcolor"><path d="M2295 11929c-284-12-642-45-707-65-17-5-18-63-18-1039 0-569 4-1036 8-1039 5-3 74 6 153 19 510 86 1168 95 1789 25 1348-153 2602-677 3670-1531 385-308 820-744 1126-1129 842-1060 1362-2313 1514-3650 70-621 61-1279-25-1789-13-79-22-148-19-153 3-4 471-8 1039-8h1035l5 23c51 225 85 942 67 1419-23 605-77 1044-198 1617-294 14e2-927 2734-1823 3846-1043 1295-2364 2259-3909 2854-1158 447-2451 656-3707 6e2z"/><path d="M2255 7845c-269-25-620-81-667-106-17-9-18-55-18-899 0-706 3-890 13-890 6 0 66 18 132 41 130 44 288 79 467 105 154 21 577 30 749 15 1207-107 2267-823 2814-1902 166-327 268-637 330-1001 38-227 48-384 42-662-8-348-44-590-126-831-23-66-41-126-41-132 0-10 184-13 890-13 844 0 890 1 899 18 27 50 88 452 110 725 14 162 14 624 1 782-59 703-233 1323-545 1945-481 956-1313 1788-2270 2268-620 310-1239 483-1940 542-165 14-669 10-840-5z"/><path d="M2519 3815c-391-66-725-336-868-703-79-201-96-462-45-677 83-344 338-641 666-774 116-47 205-69 330-80 412-39 811 153 1040 5e2 193 292 240 648 128 981-135 403-492 699-914 757-1e2 14-241 12-337-4z"/></g></svg></a><p class=footnote>powered by <a target=_blank href=https://gohugo.io>Hugo</a> | themed with <a target=_blank href=https://github.com/lukeorth/poison>poison</a><br>&copy; 2024 . All rights reserved.</p></div></aside><main class="content container"><div class=post><div class=info><h1 class=post-title><a href=https://gosang.github.io/posts/dotnet/securing-asp-dotnet-core-web-api-with-oauth-2.0-in-microsoft-entra-id/>Securing ASP.NET Core Web API With OAuth 2.0 in Microsoft Entra ID</a></h1><time datetime=2024-01-28T14:22:05Z class=post-date>January 28, 2024</time><ul class=tags><li class="tag-ASP.NET Core"><a href=https://gosang.github.io/tags/asp.net-core>ASP.NET Core</a></li><li class="tag-OAuth 2.0"><a href=https://gosang.github.io/tags/oauth-2.0>OAuth 2.0</a></li></ul></div><p>OAuth 2.0 is a widely adopted protocol for securing web applications and APIs. It provides a standardized way for third-party applications to obtain limited access to a user&rsquo;s resources without exposing their credentials. In this blog post, we will explore the fundamentals of OAuth 2.0 and how to implement it to secure an ASP.NET Core Web API using Microsoft Entra ID.</p><h1 id=understanding-oauth-20>Understanding OAuth 2.0</h1><h2 id=what-is-oauth-20>What is OAuth 2.0?</h2><p>OAuth 2.0 is an open standard authorization framework that enables secure, delegated access to resources. It allows a user to grant a third-party application limited access to their resources, without sharing their credentials.</p><h2 id=why-oauth-20-and-problem-resolution>Why OAuth 2.0 and Problem Resolution</h2><p>The primary goal of OAuth 2.0 is to provide a secure and standardized way for applications to access resources on behalf of users. It resolves the issue of sharing passwords between different services and enhances security by using access tokens.</p><h2 id=oauth-20-flow>OAuth 2.0 Flow</h2><p>OAuth 2.0 defines several authorization flows that cater to different use cases. Two prominent flows are the Authorization Code Flow and the Client Credentials Flow. Let&rsquo;s look into the details of each and explore their respective use cases.</p><h3 id=oauth-20-authorization-code-flow>OAuth 2.0 Authorization Code Flow</h3><p>To implement the Authorization Code Flow, use the OpenID Connect middleware in your authentication configuration. This flow is suitable for scenarios where user interaction is required, such as a web application.</p><h3 id=oauth-20-client-credentials-flow>OAuth 2.0 Client Credentials Flow</h3><p>For scenarios where a client application needs to access resources without user involvement, use the Client Credentials Flow. In your API, configure the client application with the appropriate client ID and secret.</p><h1 id=implementing-oauth-20-with-microsoft-entra-id>Implementing OAuth 2.0 with Microsoft Entra ID</h1><h2 id=scenario-e-commerce-system>Scenario: E-commerce System</h2><p>Consider an e-commerce system with ASP.NET Core Web API backend and a React frontend. The API is built using CQRS MediatR pattern, FluentValidation for input validation, AutoMapper for object mapping, Entity Framework Core for database interactions, and Testcontainers with xUnit for unit tests.</p><h3 id=setting-up-oauth-20-registration-in-microsoft-entra-id>Setting Up OAuth 2.0 Registration in Microsoft Entra ID</h3><p>To implement OAuth 2.0 Authorization Code Flow and OAuth 2.0 Client Credentials Flow with Microsoft Entra ID, you need to register your Web API and Client Application in the Azure AD B2C portal. Below are the succinct steps for both scenarios.</p><h4 id=oauth-20-authorization-code-flow-1>OAuth 2.0 Authorization Code Flow</h4><h5 id=step-1-register-the-web-api>Step 1: Register the Web API</h5><ol><li>Go to the <code>Azure portal</code> and navigate to Azure AD B2C.</li><li>In the left-hand menu, select &ldquo;App registrations.&rdquo;</li><li>Click on &ldquo;New registration&rdquo; and fill in the required information:<ul><li><code>Name</code>: Enter a name for your API.</li><li><code>Supported account types</code>: Choose &ldquo;Accounts in any identity provider or organizational directory.&rdquo;</li><li><code>Redirect URI</code>: Add the redirect URI for your application.</li></ul></li><li>After registration, note the &ldquo;Application (client) ID&rdquo; and &ldquo;Directory (tenant) ID&rdquo; for configuration.</li><li>Under the API section, click on &ldquo;Expose an API&rdquo; and set the Application ID URI.</li><li>Add a Scope under the &ldquo;Scopes&rdquo; section, e.g., <code>access_as_user</code>.</li></ol><h5 id=step-2-register-the-client-application>Step 2: Register the Client Application</h5><ol><li>In the Azure AD B2C portal, go to &ldquo;App registrations.&rdquo;</li><li>Click on &ldquo;New registration&rdquo; and provide the necessary details:<ul><li><code>Name</code>: Enter a name for your client application.</li><li><code>Supported account types</code>: Choose &ldquo;Accounts in any identity provider or organizational directory.&rdquo;</li><li><code>Redirect URI</code>: Add the redirect URI for your application.</li></ul></li><li>After registration, note the &ldquo;Application (client) ID&rdquo; and &ldquo;Directory (tenant) ID&rdquo; for configuration.</li><li>Under the &ldquo;Authentication&rdquo; section, configure the following:<ul><li><code>Implicit grant and hybrid flows</code>: Select &ldquo;ID token&rdquo; and &ldquo;Access token.&rdquo;</li></ul></li><li>Under the &ldquo;API permissions&rdquo; section, add the permissions required, including the Scope defined in the Web API.</li></ol><h4 id=oauth-20-client-credentials-flow-1>OAuth 2.0 Client Credentials Flow</h4><h5 id=step-1-register-the-web-api-1>Step 1: Register the Web API</h5><ol><li>Follow Steps 1-5 from the Authorization Code Flow to register your Web API.</li><li>Under the &ldquo;API permissions&rdquo; section, add the necessary permissions required for your API.</li></ol><h5 id=step-2-register-the-client-application-1>Step 2: Register the Client Application</h5><ol><li>Follow Steps 1-3 from the Authorization Code Flow to register your Client Application.</li><li>After registration, note the &ldquo;Application (client) ID&rdquo; and &ldquo;Directory (tenant) ID&rdquo; for configuration.</li><li>Under the &ldquo;Authentication&rdquo; section, configure the following:<ul><li><code>Treat application as a public client</code>: Set it to &ldquo;Yes.&rdquo;</li></ul></li><li>Under the &ldquo;Certificates & secrets&rdquo; section, generate a new client secret and note it for configuration.</li><li>Under the &ldquo;API permissions&rdquo; section, add the necessary permissions required for your API.</li></ol><p>These configurations will enable your ASP.NET Core Web API to validate tokens and authorize requests.</p><p>By registering your Web API and Client Application in Microsoft Entra ID, you enable secure OAuth 2.0 flows. The provided steps ensure proper configuration for both Authorization Code Flow and Client Credentials Flow, allowing your applications to authenticate and authorize seamlessly.</p><h4 id=configuration-in-aspnet-core>Configuration in ASP.NET Core</h4><p>In your ASP.NET Core project, use the obtained values to configure OAuth 2.0 in appsettings.json or directly in code:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;AzureAd&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;Instance&#34;</span>: <span style=color:#e6db74>&#34;https://login.microsoftonline.com/&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;Domain&#34;</span>: <span style=color:#e6db74>&#34;&lt;Your Tenant Domain&gt;&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;TenantId&#34;</span>: <span style=color:#e6db74>&#34;&lt;Directory (tenant) ID&gt;&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;ClientId&#34;</span>: <span style=color:#e6db74>&#34;&lt;Application (client) ID&gt;&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;CallbackPath&#34;</span>: <span style=color:#e6db74>&#34;/signin-oidc&#34;</span>
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;ApiScope&#34;</span>: <span style=color:#e6db74>&#34;api://&lt;Web API Application ID URI&gt;/access_as_user&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=implementing-oauth-20-with-microsoft-entra-id-1>Implementing OAuth 2.0 with Microsoft Entra ID</h2><p>Securing your ASP.NET Core Web API with OAuth 2.0 using Microsoft Entra ID involves several steps to configure authentication and authorization. Microsoft Entra ID is a solution that integrates with Azure AD B2C to provide secure and seamless identity management. Here&rsquo;s a succinct guide on how to implement OAuth 2.0 in your .NET Core API.</p><h3 id=sample-net-core-api-project>Sample .NET Core API Project</h3><h4 id=step-1-install-required-nuget-packages>Step 1: Install required NuGet packages</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>dotnet add package Microsoft.AspNetCore.Authentication.OpenIdConnect
</span></span><span style=display:flex><span>dotnet add package Microsoft.Identity.Web
</span></span></code></pre></div><h4 id=step-2-configure-oauth-20-with-entra-id>Step 2: Configure OAuth 2.0 with Entra ID</h4><p>In your <code>Startup.cs</code> file, configure authentication services:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> ConfigureServices(IServiceCollection services)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Other configurations...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    services.AddAuthentication(OpenIdConnectDefaults.AuthenticationScheme)
</span></span><span style=display:flex><span>    .AddMicrosoftIdentityWebApp(Configuration.GetSection(<span style=color:#e6db74>&#34;AzureAd&#34;</span>))
</span></span><span style=display:flex><span>    .EnableTokenAcquisitionToCallDownstreamApi(<span style=color:#66d9ef>new</span> <span style=color:#66d9ef>string</span>[] { Configuration[<span style=color:#e6db74>&#34;ApiScope&#34;</span>] })
</span></span><span style=display:flex><span>    .AddInMemoryTokenCaches();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>services.AddAuthentication(Configuration.GetSection(<span style=color:#e6db74>&#34;ApiAuth:Scheme&#34;</span>))
</span></span><span style=display:flex><span>    .AddJwtBearer(Configuration.GetSection(<span style=color:#e6db74>&#34;ApiAuth&#34;</span>))
</span></span><span style=display:flex><span>    .AddMicrosoftIdentityWebApi(Configuration.GetSection(<span style=color:#e6db74>&#34;AzureAd&#34;</span>))
</span></span><span style=display:flex><span>    .EnableTokenAcquisitionToCallDownstreamApi(<span style=color:#66d9ef>new</span> <span style=color:#66d9ef>string</span>[] { Configuration[<span style=color:#e6db74>&#34;ApiScope&#34;</span>] })
</span></span><span style=display:flex><span>    .AddInMemoryTokenCaches();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Other configurations...</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> Configure(IApplicationBuilder app, IWebHostEnvironment env)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Other configurations...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    app.UseAuthentication();
</span></span><span style=display:flex><span>    app.UseAuthorization();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Other configurations...</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=step-3-secure-api-controller>Step 3: Secure API Controller</h4><p>In your API controller, use the <code>[Authorize]</code> attribute to enforce authentication:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#a6e22e>[Authorize]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>[ApiController]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>[Route(&#34;api/products&#34;)]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ProductsController</span> : ControllerBase
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Controller logic here</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Or use the <code>[Authorize]</code> attribute for user-based access and <code>[AuthorizeForScopes]</code> for client credentials-based access:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#a6e22e>[Authorize]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>[ApiController]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>[Route(&#34;api/products&#34;)]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ProductsController</span> : ControllerBase
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Controller logic for user-based access</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>    [AuthorizeForScopes(Scopes = new[]</span> { <span style=color:#e6db74>&#34;api://&lt;client-id&gt;/access_as_user&#34;</span> })]
</span></span><span style=display:flex><span><span style=color:#a6e22e>    [HttpGet(&#34;admin&#34;)]</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> IActionResult AdminEndpoint()
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Controller logic for client credentials-based access</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Now, your API is protected, and only authenticated users can access the <code>ProductsController</code>.</p><h1 id=advantages-and-disadvantages>Advantages and Disadvantages</h1><h2 id=advantages>Advantages</h2><ul><li><strong>Security</strong>: OAuth 2.0 enhances security by eliminating the need to share credentials between services.</li><li><strong>Standardization</strong>: Being an open standard, OAuth 2.0 provides a consistent and widely accepted way of implementing authorization.</li></ul><h2 id=disadvantages>Disadvantages</h2><ul><li><strong>Complexity</strong>: Implementing OAuth 2.0 can be complex, especially for beginners.</li><li><strong>Token Management</strong>: Proper token management is crucial, and improper handling can lead to security vulnerabilities.</li></ul><h1 id=issues-and-considerations>Issues and Considerations</h1><ul><li><strong>Token Expiry</strong>: Regularly refresh tokens to avoid expiration issues.</li><li><strong>Scope Definition</strong>: Clearly define and limit the scopes of access tokens.</li><li><strong>Logging and Monitoring</strong>: Implement robust logging and monitoring to track unauthorized access attempts.</li></ul><h1 id=when-to-use-oauth-20>When to Use OAuth 2.0</h1><p>Use OAuth 2.0 when:</p><ul><li><strong>Third-Party Access</strong>: You need to allow third-party applications to access user resources.</li><li><strong>Standardization is Essential</strong>: You want to follow a widely accepted standard for authorization.</li></ul><h1 id=when-not-to-use-oauth-20>When Not to Use OAuth 2.0</h1><p>Avoid OAuth 2.0 when:</p><ul><li><strong>Simplicity is Preferred</strong>: For simple scenarios, where the overhead of OAuth 2.0 is not justified.</li><li><strong>Internal Access Only</strong>: If all consumers of the API are internal services with no need for external authorization.</li></ul><h1 id=best-practices>Best Practices</h1><ul><li><strong>Use HTTPS</strong>: Always use HTTPS to encrypt communication.</li><li><strong>Token Validation</strong>: Implement thorough validation of access tokens.</li><li><strong>Keep Secrets Secure</strong>: Safeguard client secrets and other sensitive information.</li><li><strong>Regular Updates</strong>: Stay updated with the latest OAuth 2.0 specifications and security best practices.</li></ul><h1 id=conclusion>Conclusion</h1><p>Implementing OAuth 2.0 with Microsoft Entra ID enhances the security of your ASP.NET Core Web API, especially in the context of an e-commerce system. While it adds complexity, the advantages of standardization and improved security outweigh the challenges. Follow best practices, be mindful of considerations, and OAuth 2.0 will be a robust solution for securing your API.</p><h1 id=references>References:</h1><p><a href=https://learn.microsoft.com/en-us/entra/architecture/auth-oauth2 target=_blank>Microsoft OAuth 2.0</a>
<a href=https://learn.microsoft.com/en-us/entra/msal/dotnet/microsoft-identity-web/ target=_blank>Microsoft Identity Web</a>
<a href=https://oauth.net/2/ target=_blank>OAuth 2.0 Specification</a></p><hr><div class=footer><a class=previous-post href="https://gosang.github.io/posts/datastore/optimistic-concurrency-with-etag-in-asp-dotnet-core-8/?ref=footer"><span style=font-weight:700>« Previous</span><br>Optimistic Concurrency With Etag in ASP.NET Core 8</a><div class=next-post><a href="https://gosang.github.io/posts/devops/kubernetes/understanding-kubernetes-a-developer-guide/?ref=footer"><span style=font-weight:700>Next »</span><br>Understanding Kubernetes: A Developer`s Guide</a></div></div></div></main><div class=article-toc><div class=toc-wrapper><h4 id=contents></h4><nav id=TableOfContents><ul><li><a href=#what-is-oauth-20>What is OAuth 2.0?</a></li><li><a href=#why-oauth-20-and-problem-resolution>Why OAuth 2.0 and Problem Resolution</a></li><li><a href=#oauth-20-flow>OAuth 2.0 Flow</a><ul><li><a href=#oauth-20-authorization-code-flow>OAuth 2.0 Authorization Code Flow</a></li><li><a href=#oauth-20-client-credentials-flow>OAuth 2.0 Client Credentials Flow</a></li></ul></li></ul><ul><li><a href=#scenario-e-commerce-system>Scenario: E-commerce System</a><ul><li><a href=#setting-up-oauth-20-registration-in-microsoft-entra-id>Setting Up OAuth 2.0 Registration in Microsoft Entra ID</a></li></ul></li><li><a href=#implementing-oauth-20-with-microsoft-entra-id-1>Implementing OAuth 2.0 with Microsoft Entra ID</a><ul><li><a href=#sample-net-core-api-project>Sample .NET Core API Project</a></li></ul></li></ul><ul><li><a href=#advantages>Advantages</a></li><li><a href=#disadvantages>Disadvantages</a></li></ul></nav></div></div></div></body></html>