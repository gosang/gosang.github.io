<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en-us lang=en-us><head><script defer language=javascript type=text/javascript src=/js/bundle.min.11d62625e7495f8147fccf5d08f37bded574a50c4508c235cc666848567d99ab.js></script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon href=/favicon.png><title itemprop=name>Go Sang - Advanced Server Rendering: React Query With Next.js App Router</title><meta property="og:title" content="Go Sang - Advanced Server Rendering: React Query With Next.js App Router"><meta name=twitter:title content="Go Sang - Advanced Server Rendering: React Query With Next.js App Router"><meta itemprop=name content="Go Sang - Advanced Server Rendering: React Query With Next.js App Router"><meta name=application-name content="Go Sang - Advanced Server Rendering: React Query With Next.js App Router"><meta property="og:site_name" content><meta name=description content><meta itemprop=description content><meta property="og:description" content><meta name=twitter:description content><base href=https://gosang.github.io/posts/react/advanced-server-rendering-react-query-with-nextjs-app-router/><link rel=canonical href=https://gosang.github.io/posts/react/advanced-server-rendering-react-query-with-nextjs-app-router/ itemprop=url><meta name=url content="https://gosang.github.io/posts/react/advanced-server-rendering-react-query-with-nextjs-app-router/"><meta name=twitter:url content="https://gosang.github.io/posts/react/advanced-server-rendering-react-query-with-nextjs-app-router/"><meta property="og:url" content="https://gosang.github.io/posts/react/advanced-server-rendering-react-query-with-nextjs-app-router/"><meta property="og:updated_time" content="2006-02-11T650:29:24+0100"><link rel=sitemap type=application/xml title=Sitemap href=https://gosang.github.io/sitemap.xml><meta name=robots content="index,follow"><meta name=googlebot content="index,follow"><meta name=twitter:site content><meta name=twitter:creator content><meta property="fb:admins" content><meta name=apple-mobile-web-app-title content><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="black"><meta property="og:type" content="article"><meta property="article:publisher" content><meta property="og:article:published_time" content="2006-02-11T650:29:24+0100"><meta property="article:published_time" content="2006-02-11T650:29:24+0100"><script defer type=application/ld+json>{"@context":"http://schema.org","@type":"Article","headline":"Advanced Server Rendering: React Query With Next.js App Router","author":{"@type":"Person","name":"https:\/\/github.com\/gosang"},"datePublished":"2024-06-02","description":"","wordCount":"1406","mainEntityOfPage":"True","dateModified":"2024-06-02","image":{"@type":"imageObject","url":""},"publisher":{"@type":"Organization","name":"","logo":{"@type":"imageObject","url":""}}}</script><meta name=generator content="Hugo 0.119.0"><link type=text/css rel=stylesheet href=/css/bundle.min.178e339ccb9acabffeebf9adbb0bb23c1ec0b72a2a50edee18a5007d4d5a68aa.css><style>body{--sidebar-bg-color:#202020;--sidebar-img-border-color:#515151;--sidebar-p-color:#909090;--sidebar-h1-color:#FFF;--sidebar-a-color:#FFF;--sidebar-socials-color:#FFF;--text-color:#222;--bkg-color:#FAF9F6;--post-title-color:#303030;--list-color:#5a5a5a;--link-color:#268bd2;--date-color:#515151;--table-border-color:#E5E5E5;--table-stripe-color:#F9F9F9;--code-color:#bf616a;--code-background-color:#E5E5E5;--moon-sun-color:#FFF;--moon-sun-background-color:#515151}body.dark-theme{--text-color:#eee;--bkg-color:#121212;--post-title-color:#DBE2E9;--list-color:#9d9d9d;--link-color:#268bd2;--date-color:#9a9a9a;--table-border-color:#515151;--table-stripe-color:#202020;--code-color:#ff7f7f;--code-background-color:#393D47}body{background-color:var(--bkg-color)}</style></head><body><div class=wrapper><aside class=sidebar><div class="container sidebar-sticky"><div class=light-dark align=right><button class=btn-light-dark title="Toggle light/dark mode"><svg class="moon" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 16 16"><path fill="currentcolor" d="M6 .278a.768.768.0 01.08.858 7.208 7.208.0 00-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527.0 1.04-.055 1.533-.16a.787.787.0 01.81.316.733.733.0 01-.031.893A8.349 8.349.0 018.344 16C3.734 16 0 12.286.0 7.71.0 4.266 2.114 1.312 5.124.06A.752.752.0 016 .278z"/></svg><svg class="sun" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 16 16"><path fill="currentcolor" d="M8 12a4 4 0 100-8 4 4 0 000 8zM8 0a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 0zm0 13a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 13zm8-5a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2a.5.5.0 01.5.5zM3 8a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2A.5.5.0 013 8zm10.657-5.657a.5.5.0 010 .707l-1.414 1.415a.5.5.0 11-.707-.708l1.414-1.414a.5.5.0 01.707.0zm-9.193 9.193a.5.5.0 010 .707L3.05 13.657a.5.5.0 01-.707-.707l1.414-1.414a.5.5.0 01.707.0zm9.193 2.121a.5.5.0 01-.707.0l-1.414-1.414a.5.5.0 01.707-.707l1.414 1.414a.5.5.0 010 .707zM4.464 4.465a.5.5.0 01-.707.0L2.343 3.05a.5.5.0 11.707-.707l1.414 1.414a.5.5.0 010 .708z"/></svg></button></div><div class=sidebar-about><h1 class=brand><a href=https://gosang.github.io/><h1>Go Sang</h1></a></h1><p class=lead>Learning about technology.</p></div><nav><ul class=sidebar-nav><li class=heading><a href=/posts/>Posts</a></li><li class=sub-heading>Recent</li><li class=bullet><a href=https://gosang.github.io/posts/react/error-handling-in-nextjs-with-typescript/>Error Handling in Next.js With TypeScript</a></li><li class=bullet><a href=https://gosang.github.io/posts/react/callback-promise-async-await-in-javascript/>Callback Promise Async Await in Javascript</a></li><li class=bullet><a href=https://gosang.github.io/posts/dotnet/implementing-postgresql-in-asp-dotnet-core/>Implementing PostgreSQL with ASP.NET Core</a></li><li class=bullet><a href=https://gosang.github.io/posts/dotnet/implementing-uuid-in-asp-dotnet-core/>Implementing UUID in ASP.NET Core 8</a></li><li class=bullet><a href=https://gosang.github.io/posts/dotnet/implementing-guid-in-asp-dotnet-core/>Implementing GUID in ASP.NET Core</a></li></ul></nav><a target=_blank class=social title=GitHub href=https://github.com/gosang><svg xmlns="http://www.w3.org/2000/svg" width="1.2em" height="1.2em" viewBox="-2 -2 24 24"><path fill="currentcolor" d="M18.88 1.099C18.147.366 17.265.0 16.233.0H3.746C2.714.0 1.832.366 1.099 1.099.366 1.832.0 2.714.0 3.746v12.487c0 1.032.366 1.914 1.099 2.647.733.733 1.615 1.099 2.647 1.099H6.66c.19.0.333-.007.429-.02a.504.504.0 00.286-.169c.095-.1.143-.245.143-.435l-.007-.885c-.004-.564-.006-1.01-.006-1.34l-.3.052c-.19.035-.43.05-.721.046a5.555 5.555.0 01-.904-.091 2.026 2.026.0 01-.872-.39 1.651 1.651.0 01-.572-.8l-.13-.3a3.25 3.25.0 00-.41-.663c-.186-.243-.375-.407-.566-.494l-.09-.065a.956.956.0 01-.17-.156.723.723.0 01-.117-.182c-.026-.061-.004-.111.065-.15.07-.04.195-.059.378-.059l.26.04c.173.034.388.138.643.311a2.1 2.1.0 01.631.677c.2.355.44.626.722.813.282.186.566.28.852.28.286.0.533-.022.742-.065a2.59 2.59.0 00.585-.196c.078-.58.29-1.028.637-1.34a8.907 8.907.0 01-1.333-.234 5.314 5.314.0 01-1.223-.507 3.5 3.5.0 01-1.047-.872c-.277-.347-.505-.802-.683-1.365-.177-.564-.266-1.215-.266-1.952.0-1.049.342-1.942 1.027-2.68-.32-.788-.29-1.673.091-2.652.252-.079.625-.02 1.119.175.494.195.856.362 1.086.5.23.14.414.257.553.352a9.233 9.233.0 012.497-.338c.859.0 1.691.113 2.498.338l.494-.312a6.997 6.997.0 011.197-.572c.46-.174.81-.221 1.054-.143.39.98.424 1.864.103 2.653.685.737 1.028 1.63 1.028 2.68.0.737-.089 1.39-.267 1.957-.177.568-.407 1.023-.689 1.366a3.65 3.65.0 01-1.053.865c-.42.234-.828.403-1.223.507a8.9 8.9.0 01-1.333.235c.45.39.676 1.005.676 1.846v3.11c0 .147.021.266.065.357a.36.36.0 00.208.189c.096.034.18.056.254.064.074.01.18.013.318.013h2.914c1.032.0 1.914-.366 2.647-1.099.732-.732 1.099-1.615 1.099-2.647V3.746c0-1.032-.367-1.914-1.1-2.647z"/></svg></a><a target=_blank class=social title="RSS Feed" href=https://gosang.github.io//posts/index.xml><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1.2em" viewBox="0 0 1280 1280"><g transform="translate(0.000000,1280.000000) scale(0.100000,-0.100000)" fill="currentcolor"><path d="M2295 11929c-284-12-642-45-707-65-17-5-18-63-18-1039 0-569 4-1036 8-1039 5-3 74 6 153 19 510 86 1168 95 1789 25 1348-153 2602-677 3670-1531 385-308 820-744 1126-1129 842-1060 1362-2313 1514-3650 70-621 61-1279-25-1789-13-79-22-148-19-153 3-4 471-8 1039-8h1035l5 23c51 225 85 942 67 1419-23 605-77 1044-198 1617-294 14e2-927 2734-1823 3846-1043 1295-2364 2259-3909 2854-1158 447-2451 656-3707 6e2z"/><path d="M2255 7845c-269-25-620-81-667-106-17-9-18-55-18-899 0-706 3-890 13-890 6 0 66 18 132 41 130 44 288 79 467 105 154 21 577 30 749 15 1207-107 2267-823 2814-1902 166-327 268-637 330-1001 38-227 48-384 42-662-8-348-44-590-126-831-23-66-41-126-41-132 0-10 184-13 890-13 844 0 890 1 899 18 27 50 88 452 110 725 14 162 14 624 1 782-59 703-233 1323-545 1945-481 956-1313 1788-2270 2268-620 310-1239 483-1940 542-165 14-669 10-840-5z"/><path d="M2519 3815c-391-66-725-336-868-703-79-201-96-462-45-677 83-344 338-641 666-774 116-47 205-69 330-80 412-39 811 153 1040 5e2 193 292 240 648 128 981-135 403-492 699-914 757-1e2 14-241 12-337-4z"/></g></svg></a><p class=footnote>powered by <a target=_blank href=https://gohugo.io>Hugo</a> | themed with <a target=_blank href=https://github.com/lukeorth/poison>poison</a><br>&copy; 2025 . All rights reserved.</p></div></aside><main class="content container"><div class=post><div class=info><h1 class=post-title><a href=https://gosang.github.io/posts/react/advanced-server-rendering-react-query-with-nextjs-app-router/>Advanced Server Rendering: React Query With Next.js App Router</a></h1><time datetime=2024-06-02T11:50:29+0100 class=post-date>June 2, 2024</time><ul class=tags><li class=tag-React><a href=https://gosang.github.io/tags/react>React</a></li><li class=tag-SSR><a href=https://gosang.github.io/tags/ssr>SSR</a></li><li class="tag-React Query"><a href=https://gosang.github.io/tags/react-query>React Query</a></li></ul></div><p>Server-side rendering (SSR) and static site generation (SSG) are essential techniques in modern web development to improve performance, SEO, and user experience. In this blog, we will look into how to effectively use React Query with the Next.js App Router for advanced server rendering. We will cover the concepts, setup, and practical implementations with React and TypeScript examples. Let&rsquo;s get started!</p><h1 id=understanding-server-rendering>Understanding Server Rendering</h1><h2 id=server-side-rendering-ssr>Server-Side Rendering (SSR)</h2><p>SSR generates HTML on the server for each request. This approach benefits applications by improving SEO, providing faster initial load times, and enhancing user experience.</p><h3 id=benefits-of-ssr>Benefits of SSR:</h3><ul><li><strong>Improved SEO</strong>: Search engines can better index pre-rendered content.</li><li><strong>Faster Initial Load</strong>: Users see a fully rendered page quicker, enhancing perceived performance.</li><li><strong>Enhanced User Experience</strong>: Less time is spent loading and rendering content on the client side.</li></ul><h2 id=static-site-generation-ssg>Static Site Generation (SSG)</h2><p>SSG pre-renders pages at build time, generating static HTML files. These files are then served directly to users, providing fast load times and efficient caching.</p><h3 id=benefits-of-ssg>Benefits of SSG:</h3><ul><li><strong>Performance</strong>: Pre-rendered pages load quickly.</li><li><strong>Scalability</strong>: Static files can be served from a CDN.</li><li><strong>Cost-Effective</strong>: Reduced server load and maintenance costs.</li></ul><h1 id=what-is-react-query>What is React Query?</h1><p>React Query is a library for managing server-state in React applications. It simplifies data fetching, caching, synchronization, and more, making it easier to handle asynchronous operations.</p><h2 id=key-features-of-react-query>Key Features of React Query:</h2><ul><li><strong>Data Caching</strong>: Automatically caches fetched data to improve performance.</li><li><strong>Synchronization</strong>: Keeps data synchronized between server and client.</li><li><strong>Query Invalidation</strong>: Invalidates queries to refetch data when necessary.</li><li><strong>Background Fetching</strong>: Fetches data in the background, providing a seamless user experience.</li></ul><h1 id=what-is-the-nextjs-app-router>What is the Next.js App Router?</h1><p>The Next.js App Router is an advanced routing mechanism providing better control over routing in Next.js applications. It enables nested routes, layouts, and flexible data fetching strategies.</p><h1 id=combining-ssr-react-query-and-nextjs-app-router>Combining SSR, React Query, and Next.js App Router</h1><h2 id=rationale>Rationale</h2><p>Combining SSR with React Query in Next.js provides a robust solution for handling server-state and routing. This approach addresses common challenges such as:</p><ul><li><strong>SEO Optimization</strong>: Pre-rendered HTML content improves SEO.</li><li><strong>Performance</strong>: Faster page loads due to server-rendered content.</li><li><strong>Data Management</strong>: Simplified data fetching and synchronization using React Query.</li></ul><h2 id=how-they-work-together>How They Work Together</h2><ul><li><strong>Server Rendering</strong>: Next.js pre-renders the page with initial data fetched using React Query.</li><li><strong>Hydration</strong>: The pre-rendered HTML is sent to the client, where React Query rehydrates with the fetched data.</li><li><strong>Routing</strong>: The Next.js App Router handles navigation and routing, allowing seamless transitions between pages.</li></ul><h1 id=setting-up-server-rendering-with-react-query-and-nextjs-app-router>Setting Up Server Rendering with React Query and Next.js App Router</h1><h2 id=initial-setup>Initial Setup</h2><h3 id=create-a-react-query-client>Create a React Query Client</h3><p>To manage server-state effectively with React Query, we need to create a QueryClient instance, which will handle our queries, mutations, and caching.</p><ol><li>Install Dependencies:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>npm install next react react-dom react-query
</span></span></code></pre></div><ol start=2><li>Create a QueryClient Instance:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// lib/reactQueryClient.ts
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>QueryClient</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;react-query&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>queryClient</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>QueryClient</span>();
</span></span></code></pre></div><p>In this file, we import <code>QueryClient</code> from <code>react-query</code> and export a new instance of <code>QueryClient</code>. This instance will be used to manage our queries and caching logic.</p><h3 id=configure-nextjs-app>Configure Next.js App</h3><p>Next, we need to configure our Next.js app to use the <code>QueryClientProvider</code> to make the query client available throughout our application.</p><ol><li>Configure Next.js App with QueryClientProvider:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// pages/_app.tsx
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>AppProps</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;next/app&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>QueryClientProvider</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;react-query&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>queryClient</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;../lib/reactQueryClient&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>MyApp</span>({ <span style=color:#a6e22e>Component</span>, <span style=color:#a6e22e>pageProps</span> }<span style=color:#f92672>:</span> <span style=color:#a6e22e>AppProps</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> (
</span></span><span style=display:flex><span>    &lt;<span style=color:#f92672>QueryClientProvider</span> <span style=color:#a6e22e>client</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>queryClient</span>}&gt;
</span></span><span style=display:flex><span>      &lt;<span style=color:#f92672>Component</span> {<span style=color:#a6e22e>...pageProps</span>} /&gt;
</span></span><span style=display:flex><span>    &lt;/<span style=color:#f92672>QueryClientProvider</span>&gt;
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#a6e22e>MyApp</span>;
</span></span></code></pre></div><p>Here, we wrap our application with the <code>QueryClientProvider</code> and pass the <code>queryClient</code> instance to it. This setup ensures that React Query is properly configured and available across our entire app.</p><h2 id=server-side-data-fetching>Server-Side Data Fetching</h2><p>Server-side data fetching involves pre-fetching data on the server before rendering the page. This data is then passed to the client, allowing for faster initial load times and better SEO.</p><h3 id=fetch-data-on-the-server>Fetch Data on the Server</h3><ol><li>Fetch Data on the Server:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// pages/index.tsx
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>GetServerSideProps</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;next&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>useQuery</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;react-query&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>dehydrate</span>, <span style=color:#a6e22e>QueryClient</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;react-query/hydration&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fetchUsers</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>async</span> () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>res</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>fetch</span>(<span style=color:#e6db74>&#34;https://jsonplaceholder.typicode.com/users&#34;</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>json</span>();
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>getServerSideProps</span>: <span style=color:#66d9ef>GetServerSideProps</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>async</span> () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>queryClient</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>QueryClient</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>queryClient</span>.<span style=color:#a6e22e>prefetchQuery</span>(<span style=color:#e6db74>&#34;users&#34;</span>, <span style=color:#a6e22e>fetchUsers</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>props</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>dehydratedState</span>: <span style=color:#66d9ef>dehydrate</span>(<span style=color:#a6e22e>queryClient</span>),
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>HomePage</span> <span style=color:#f92672>=</span> () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>data</span>, <span style=color:#a6e22e>error</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>useQuery</span>(<span style=color:#e6db74>&#34;users&#34;</span>, <span style=color:#a6e22e>fetchUsers</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>error</span>) <span style=color:#66d9ef>return</span> &lt;<span style=color:#f92672>div</span>&gt;Error <span style=color:#a6e22e>loading</span> <span style=color:#a6e22e>users</span>&lt;/<span style=color:#f92672>div</span>&gt;;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> (
</span></span><span style=display:flex><span>    &lt;<span style=color:#f92672>div</span>&gt;
</span></span><span style=display:flex><span>      {<span style=color:#a6e22e>data</span><span style=color:#f92672>?</span>.<span style=color:#a6e22e>map</span>((<span style=color:#a6e22e>user</span>: <span style=color:#66d9ef>any</span>) <span style=color:#f92672>=&gt;</span> (
</span></span><span style=display:flex><span>        &lt;<span style=color:#f92672>div</span> <span style=color:#a6e22e>key</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>id</span>}&gt;{<span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>name</span>}&lt;/<span style=color:#f92672>div</span>&gt;
</span></span><span style=display:flex><span>      ))}
</span></span><span style=display:flex><span>    &lt;/<span style=color:#f92672>div</span>&gt;
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#a6e22e>HomePage</span>;
</span></span></code></pre></div><ul><li><strong>GetServerSideProps</strong>: This function runs on the server side and allows us to fetch data before rendering the page.</li><li><strong>QueryClient</strong>: A new instance of <code>QueryClient</code> is created for each request.</li><li><strong>PrefetchQuery</strong>: We use <code>prefetchQuery</code> to fetch and cache the data on the server.</li><li><strong>Dehydrate</strong>: The <code>dehydrate</code> function serializes the query cache to be passed as props to the client.</li></ul><h2 id=hydration>Hydration</h2><p>Hydration is the process of synchronizing the server-rendered HTML with the client-side JavaScript. React Query uses hydration APIs to rehydrate the state on the client-side using the pre-fetched data from the server.</p><h3 id=hydrate-the-state-on-the-client-side>Hydrate the State on the Client-Side</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// pages/_app.tsx
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>Hydrate</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;react-query/hydration&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>AppProps</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;next/app&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>QueryClientProvider</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;react-query&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>queryClient</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;../lib/reactQueryClient&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>MyApp</span>({ <span style=color:#a6e22e>Component</span>, <span style=color:#a6e22e>pageProps</span> }<span style=color:#f92672>:</span> <span style=color:#a6e22e>AppProps</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> (
</span></span><span style=display:flex><span>    &lt;<span style=color:#f92672>QueryClientProvider</span> <span style=color:#a6e22e>client</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>queryClient</span>}&gt;
</span></span><span style=display:flex><span>      &lt;<span style=color:#f92672>Hydrate</span> <span style=color:#a6e22e>state</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>pageProps</span>.<span style=color:#a6e22e>dehydratedState</span>}&gt;
</span></span><span style=display:flex><span>        &lt;<span style=color:#f92672>Component</span> {<span style=color:#a6e22e>...pageProps</span>} /&gt;
</span></span><span style=display:flex><span>      &lt;/<span style=color:#f92672>Hydrate</span>&gt;
</span></span><span style=display:flex><span>    &lt;/<span style=color:#f92672>QueryClientProvider</span>&gt;
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#a6e22e>MyApp</span>;
</span></span></code></pre></div><ul><li><strong>Hydrate Component</strong>: The Hydrate component takes the dehydratedState from pageProps and rehydrates the query cache on the client side. This ensures that the client has the same initial state as the server-rendered HTML.</li></ul><h3 id=improve-hydration-with-hydration-boundaries>Improve Hydration with Hydration Boundaries</h3><p>Using hydration boundaries, we can improve the performance and user experience by isolating parts of the UI that need to be hydrated separately. This approach ensures that critical parts of the UI are interactive sooner.</p><ol><li>Create a Hydration Boundary Component:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// components/HydrationBoundary.tsx
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>Hydrate</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;react-query/hydration&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>ReactNode</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;react&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>HydrationBoundaryProps</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>state</span>: <span style=color:#66d9ef>any</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>children</span>: <span style=color:#66d9ef>ReactNode</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>HydrationBoundary</span> <span style=color:#f92672>=</span> ({ <span style=color:#a6e22e>state</span>, <span style=color:#a6e22e>children</span> }<span style=color:#f92672>:</span> <span style=color:#a6e22e>HydrationBoundaryProps</span>) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> &lt;<span style=color:#f92672>Hydrate</span> <span style=color:#a6e22e>state</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>state</span>}&gt;{<span style=color:#a6e22e>children</span>}&lt;/<span style=color:#f92672>Hydrate</span>&gt;;
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#a6e22e>HydrationBoundary</span>;
</span></span></code></pre></div><ol start=2><li>Use Hydration Boundaries in Your App:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// pages/_app.tsx
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>AppProps</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;next/app&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>QueryClientProvider</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;react-query&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>queryClient</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;../lib/reactQueryClient&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>HydrationBoundary</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;../components/HydrationBoundary&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>MyApp</span>({ <span style=color:#a6e22e>Component</span>, <span style=color:#a6e22e>pageProps</span> }<span style=color:#f92672>:</span> <span style=color:#a6e22e>AppProps</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> (
</span></span><span style=display:flex><span>    &lt;<span style=color:#f92672>QueryClientProvider</span> <span style=color:#a6e22e>client</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>queryClient</span>}&gt;
</span></span><span style=display:flex><span>      &lt;<span style=color:#f92672>HydrationBoundary</span> <span style=color:#a6e22e>state</span><span style=color:#f92672>=</span>{<span style=color:#a6e22e>pageProps</span>.<span style=color:#a6e22e>dehydratedState</span>}&gt;
</span></span><span style=display:flex><span>        &lt;<span style=color:#f92672>Component</span> {<span style=color:#a6e22e>...pageProps</span>} /&gt;
</span></span><span style=display:flex><span>      &lt;/<span style=color:#f92672>HydrationBoundary</span>&gt;
</span></span><span style=display:flex><span>    &lt;/<span style=color:#f92672>QueryClientProvider</span>&gt;
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#a6e22e>MyApp</span>;
</span></span></code></pre></div><p>By isolating hydration with <code>HydrationBoundary</code>, we ensure that different parts of the application can be hydrated independently, improving overall performance and user experience.</p><h1 id=advantages-and-disadvantages>Advantages and Disadvantages</h1><h2 id=advantages>Advantages</h2><ul><li><strong>SEO Friendly</strong>: Better indexing by search engines.</li><li><strong>Faster Initial Load</strong>: Improved user experience due to server-rendered content.</li><li><strong>Simplified Data Management</strong>: React Query handles data fetching and caching efficiently.</li></ul><h2 id=disadvantages>Disadvantages</h2><p>-** Increased Server Load**: SSR requires more resources on the server.</p><ul><li><strong>Complexity</strong>: Combining SSR, React Query, and Next.js App Router can increase the complexity of the application.</li><li><strong>Latency</strong>: Server response time might be higher due to the initial data fetching process.</li></ul><h1 id=when-to-use-and-not-to-use-ssr-with-react-query-and-nextjs-app-router>When to Use and Not to Use SSR with React Query and Next.js App Router</h1><h2 id=when-to-use>When to Use</h2><p>SEO-Critical Pages: Content that must be indexed by search engines.
Fast Initial Load Required: Applications where the first contentful paint is crucial for user experience.
Dynamic Data: Pages that require real-time data fetching and rendering.</p><h2 id=when-not-to-use>When Not to Use</h2><ul><li><strong>Highly Interactive UIs</strong>: Applications with extensive client-side interactivity might not benefit from SSR.</li><li><strong>Static Content</strong>: Pages with static content that doesn’t change often can be pre-rendered using Static Site Generation (SSG).</li><li><strong>Resource-Constrained Servers</strong>: SSR increases server load, which might not be suitable for applications with limited server resources.</li></ul><h1 id=issues-considerations-and-best-practices>Issues, Considerations, and Best Practices</h1><h2 id=issues>Issues</h2><ul><li><strong>State Management</strong>: Ensuring consistent state between server and client can be challenging.</li><li><strong>Error Handling</strong>: Properly handling errors during server-side data fetching.</li></ul><h2 id=considerations>Considerations</h2><ul><li><strong>Caching</strong>: Implement effective caching strategies to reduce server load.</li><li><strong>Performance Monitoring</strong>: Monitor server performance to ensure SSR does not degrade user experience.</li></ul><h2 id=best-practices>Best Practices</h2><ul><li><strong>Code Splitting</strong>: Use code splitting to improve performance by loading only necessary code.</li><li><strong>Prefetching</strong>: Prefetch data on the server to reduce client-side load times.</li><li><strong>Hydration Optimization</strong>: Optimize hydration to ensure smooth transitions from server-rendered to client-rendered content.</li></ul><h1 id=conclusion>Conclusion</h1><p>Server Rendering with React Query and Next.js App Router provides a powerful solution for creating high-performance, SEO-friendly web applications. By leveraging the strengths of each technology, developers can build applications that are both performant and user-friendly. However, it is crucial to understand the trade-offs and implement best practices to make the most out of this approach.</p><p>For further reading, check out the official documentation:</p><ul><li><a href=https://nextjs.org/docs target=_blank>Next.js Documentation</a></li><li><a href=https://tanstack.com/query/latest/docs/framework/react/overview target=_blank>React Query Documentation</a></li></ul><hr><div class=footer><a class=previous-post href="https://gosang.github.io/posts/dotnet/dotnet-aspire-simplifying-dotnet-cloud-native-development/?ref=footer"><span style=font-weight:700>« Previous</span><br>.NET Aspire: Simplifying .NET Cloud-Native...</a><div class=next-post><a href="https://gosang.github.io/posts/dotnet/api-versioning-in-asp-dotnet-core/?ref=footer"><span style=font-weight:700>Next »</span><br>API Versioning in ASP.NET Core</a></div></div></div></main><div class=article-toc><div class=toc-wrapper><h4 id=contents></h4><nav id=TableOfContents><ul><li><a href=#server-side-rendering-ssr>Server-Side Rendering (SSR)</a><ul><li><a href=#benefits-of-ssr>Benefits of SSR:</a></li></ul></li><li><a href=#static-site-generation-ssg>Static Site Generation (SSG)</a><ul><li><a href=#benefits-of-ssg>Benefits of SSG:</a></li></ul></li></ul><ul><li><a href=#key-features-of-react-query>Key Features of React Query:</a></li></ul><ul><li><a href=#rationale>Rationale</a></li><li><a href=#how-they-work-together>How They Work Together</a></li></ul><ul><li><a href=#initial-setup>Initial Setup</a><ul><li><a href=#create-a-react-query-client>Create a React Query Client</a></li><li><a href=#configure-nextjs-app>Configure Next.js App</a></li></ul></li><li><a href=#server-side-data-fetching>Server-Side Data Fetching</a><ul><li><a href=#fetch-data-on-the-server>Fetch Data on the Server</a></li></ul></li><li><a href=#hydration>Hydration</a><ul><li><a href=#hydrate-the-state-on-the-client-side>Hydrate the State on the Client-Side</a></li><li><a href=#improve-hydration-with-hydration-boundaries>Improve Hydration with Hydration Boundaries</a></li></ul></li></ul><ul><li><a href=#advantages>Advantages</a></li><li><a href=#disadvantages>Disadvantages</a></li></ul><ul><li><a href=#when-to-use>When to Use</a></li><li><a href=#when-not-to-use>When Not to Use</a></li></ul><ul><li><a href=#issues>Issues</a></li><li><a href=#considerations>Considerations</a></li><li><a href=#best-practices>Best Practices</a></li></ul></nav></div></div></div></body></html>